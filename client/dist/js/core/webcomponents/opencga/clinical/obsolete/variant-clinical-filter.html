<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!-- CHECK WHETHER variant-sample-grid IS REALLY USED -->
<!-- <link rel="import" href="variant-sample-grid.html"> -->
<link rel="import" href="../variant-clinical-selector.html">

<dom-module id="variant-clinical-filter">
    <template>
        <style><style include="jso-styles">
            .clinical-popFreqName {
                font-size: 12px;
                color: #797979;
            }

            .clinical-custom-sized-input {
                max-width: 60px;
                height: 20px;
            }

            span + span {
                margin-left: 10px;
            }

            .clinical-ct-scroll {
                max-height: 450px;
                overflow-y: scroll;
            }

            .clinical-ct-tree-view,
            .clinical-ct-tree-view * {
                padding: 0;
                margin: 0;
                list-style: none;
            }

            .clinical-ct-tree-view li ul {
                margin: 0 0 0 22px;
            }

            .clinical-ct-tree-view * {
                vertical-align: middle;
            }

            .clinical-ct-tree-view {
                font-size: 14px;
            }

            .clinical-ct-tree-view input[type="checkbox"] {
                cursor: pointer;
            }

            .clinical-ct-item {
                white-space: nowrap;
                display:inline
            }

            div.block {
                overflow:hidden;
            }

            div.block label {
                width:80px;
                display:block;
                float:left;
                text-align:left;
                font-weight: normal;
            }

            select + select {
                margin-left: 10px;
            }

            select + input {
                margin-left: 10px;
            }

            .clinical-subsection {
                padding: 5px 0px 5px 0px;
                font-weight: bold;
            }
        </style>

        <div>
            <br>
            <div style="width: 60%;margin: 0 auto">
                <button type="button" class="btn btn-primary" style="width: 100%" on-click="onSearch">
                    <i class="fa fa-search" aria-hidden="true" style="padding: 0px 5px 0px 5px"></i>
                    Search
                </button>
            </div>
            <br>

            <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true">
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="{{prefix}}SampleAnalysisHeading">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}AnalysisSelector"
                                   aria-expanded="true" aria-controls="{{prefix}}AnalysisSelector">
                                    Analysis
                                </a>
                            </h4>
                        </div>

                        <div id="{{prefix}}AnalysisSelector" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}SampleFilterHeading">
                            <div class="panel-body">
                                <label><i class="fa fa-sitemap" aria-hidden="true"></i>Select analysis:</label>
                                <br>
                                <!--<button data-toggle="modal" role="button" data-placement="bottom" data-target$="#{{prefix}}AnalysisBrowser">-->
                                <button data-toggle="modal" role="button" data-placement="bottom" on-click="showClinicalSelector">
                                    Browse...
                                </button>
                                <div id="{{prefix}}analysisSelectedDiv" style="display:none">
                                    <label>Analysis selected:</label>
                                    <input type="text" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" placeholder="{{currentAnalysisID}}" aria-describedby="basic-addon1" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- Genomic filter -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}PositionHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}Position" aria-expanded="false" aria-controls="{{prefix}}Position">
                            Genomic filters
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Introduce a region interval and/or gene/variant ids. The filter will allow variants which fall within provided genomic intervals OR match the ids provided"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}Position" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}PositionHeading">
                    <div class="panel-body">
                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}LocationDiv" style="cursor: pointer;"></i>&nbsp;Location (Chromosomal position)</label>
                        <div id="{{prefix}}LocationDiv" hidden>
                            <textarea id="{{prefix}}LocationTextarea" class$="form-control clearable {{prefix}}FilterTextInput" rows="3" placeholder="3:444-55555, 1:1-100000"
                                      name="location" on-keyup="updateQueryFilters"></textarea>
                        </div>
                        <br>

                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}FeatureDiv" style="cursor: pointer;"></i>&nbsp;Feature IDs (Genes, SNPs, ...)</label>
                        <div id="{{prefix}}FeatureDiv" hidden>
                            <textarea id="{{prefix}}FeatureTextarea" name="geneSnp" class$="form-control clearable {{prefix}}FilterTextInput"
                                      rows="3" placeholder="BRCA2, ENSG00000139618, ENST00000544455, rs28897700" on-keyup="updateQueryFilters"></textarea>
                        </div>
                        <br>

                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}BiotypeDiv" style="cursor: pointer;"></i>&nbsp;Biotype</label>
                        <div id="{{prefix}}BiotypeDiv" hidden>
                            <select multiple class$="form-control {{prefix}}FilterSelect" id="{{prefix}}GeneBiotypes" on-change="updateQueryFilters">
                                <option></option>
                                <template is="dom-repeat" items="{{biotypes}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>
                            </select>
                        </div>
                        <br>

             <!--           <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}DepthDiv" style="cursor: pointer;"></i>&nbsp;Depth</label>
                        <div id="{{prefix}}DepthDiv" hidden>
                            <div class="horizontal layout">
                                <span>Depth</span>
                                <span>
                                    <select name="DepthOperator" id="{{prefix}}{{study.id}}DepthOperator" >
                                        <option value="<" selected><</option>
                                        <option value="<="><=</option>
                                        <option value=">">></option>
                                        <option value=">=">>=</option>
                                    </select>
                                </span>
                                <span>
                                    <input type="text" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" value="" id="{{prefix}}{{study.id}}Depth">
                                </span>
                            </div>
                        </div>
                        <br>-->

                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}PanelAppDiv" style="cursor: pointer;"></i>&nbsp;PanelApp</label>
                        <div id="{{prefix}}PanelAppDiv" hidden>
                            <select class$="form-control {{prefix}}FilterSelect" id="{{prefix}}PanelApps" on-change="updatePanel">
                                <option value="none">Select a panel...</option>
                                <template is="dom-repeat" items="{{panelList}}" sort="sortPanelApp">
                                    <option value="{{item.name}}">{{item.title}} ({{item.genes.length}})</option>
                                </template>
                            </select>
                            </br>
                            <span>Panel genes:</span>
                            <textarea id="{{prefix}}PanelAppsTextarea" name="panelAppsTextarea" class$="form-control clearable {{prefix}}FilterTextInput"
                                      rows="3" placeholder="No panel selected" on-keyup="updateQueryFilters"></textarea>
                        </div>
                        <!--TODO: Update when server side starts to support all xrefs and with/without rs ids-->
                        <br>

<!--                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}UserPanelDiv" style="cursor: pointer;"></i>&nbsp;User-defined panels</label>
                        <div id="{{prefix}}UserPanelDiv" hidden>
                            <textarea id="{{prefix}}UserPanelTextarea" name="UserPanelTextarea" class$="form-control clearable {{prefix}}FilterTextInput"
                                      rows="3" placeholder="No custom panel defined" on-keyup="updateQueryFilters"></textarea>

                        </div>-->

                        <!--<textarea id="{{prefix}}FeatureTextarea" class$="form-control clearable {{prefix}}FilterTextInput" rows="5" placeholder="BRCA2, ENSG00000139618, ENST00000544455, P51587, 13:19748038:C:T, rs28897700, VAR_020705, RCV000162901, COSM3468368"-->
                        <!--name="geneSnp" on-keyup="updateQueryFilters"></textarea>-->

                        <!--<input type="checkbox" value="" class$="{{prefix}}FilterCheckBox"> With / Without dbSNP rs IDs<br>-->
                    </div>
                </div>
            </div>


            <!-- Clinical filter -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}ClinicalHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}Clinical" aria-expanded="false" aria-controls="{{prefix}}Clinical">
                            Clinical filters
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Clinical filters"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}Clinical" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}ClinicalHeading">
                    <div class="panel-body">
<!--                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}InheritanceDiv" style="cursor: pointer;"></i>&nbsp;Inheritance</label>
                        <div id="{{prefix}}InheritanceDiv" hidden>
                            <select class$="form-control {{prefix}}FilterSelect" id="{{prefix}}Inheritance">
                                <option>Select inheritance mode</option>
                                <option>Autosomal dominant</option>
                                <option>Autosomal recessive</option>
                                <option>X-linked</option>
                                <option>Y-linked</option>
                                <option>Gene with imprinting/UPD</option>
                                <option>Digenic</option>
                                <option>Compound hetherozygote</option>
                                <option>X-linked compound het.</option>
                                <option>Mithocondrial</option>
                                <option>De novo</option>
                            </select>
                        </div>
                        <br>

                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}GeneTypeDiv" style="cursor: pointer;"></i>&nbsp;Type of Genes</label>
                        <div id="{{prefix}}GeneTypeDiv" hidden></div>
                        <br>-->

                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}HPODiv" style="cursor: pointer;"></i>&nbsp;HPO</label>
                        <div id="{{prefix}}HPODiv" hidden>
                             <!--<textarea id="{{prefix}}HPOTextarea" rows="3" placeholder="HPO term"></textarea>&ndash;&gt;-->
                            <textarea id="{{prefix}}HumanPhenotypeOntologyTextarea" class$="form-control clearable {{prefix}}FilterTextInput" rows="3"
                                      name="hpo" placeholder="HP:0000001, HP:3000079" on-keyup="updateQueryFilters"></textarea>
                        </div>
                        <br>

                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}GODiv" style="cursor: pointer;"></i>&nbsp;Gene Ontology</label>
                        <div id="{{prefix}}GODiv" hidden>
                            <!--<textarea id="{{prefix}}GOTextarea" rows="3" placeholder="GO:0000145"></textarea>-->
                            <textarea id="{{prefix}}GeneOntologyTextarea" class$="form-control clearable {{prefix}}FilterTextInput" rows="3"
                                      name="geneOntology" placeholder="GO:0000145" on-keyup="updateQueryFilters"></textarea>
                        </div>
                        <br>

                        <!-- <div>
                            <input type="checkbox" value="Benign" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> Benign<br>
                            <input type="checkbox" value="LikelyBenign" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> Likely Benign<br>
                            <input type="checkbox" value="VOUS" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> VOUS<br>
                            <input type="checkbox" value="LikelyPathogenic" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> Likely Pathogenic<br>
                            <input type="checkbox" value="Pathogenic" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> Pathogenic
                        </div>-->
                    </div>
                </div>
            </div>


            <!--Population Frequency filter-->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}PopulationFrequencyHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}PopulationFrequency" aria-expanded="false" aria-controls="{{prefix}}PopulationFrequency">
                            Population Frequency
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Population Frequency filters"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}PopulationFrequency" class="panel-collapse collapse" role="tabpanel"
                     aria-labelledby="{{prefix}}PopulationFrequencyHeading">
                    <div class="panel-body">
                        <!-- CSVS puesto a pelo... -->
<!--                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}CSVSdiv" style="cursor: pointer;"></i>&nbsp;CSVS</label>
                        <div id="{{prefix}}CSVSdiv" hidden>
                            <div class="horizontal layout">
                                <span>MAF</span>
                                <span>
                                    <select name="{{popFreq.id}}Operator" id="{{prefix}}{{study.id}}CSVSOperator" >
                                        <option value="<" selected><</option>
                                        <option value="<="><=</option>
                                        <option value=">">></option>
                                        <option value=">=">>=</option>
                                    </select>
                                </span>
                                <span>
                                    <input type="text" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" value="" id="{{prefix}}{{study.id}}CSVS">
                                </span>
                            </div>
                        </div>
                        <br>-->


                        <!-- This code create the population frequencies menu filter form populationFrequencies from config.js -->
                        <template is="dom-repeat" items="{{populationFrequencies.studies}}" as="study">
                            <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}{{study.id}}" style="cursor: pointer;"></i>&nbsp;{{study.title}}</label>

                            <!-- If there is not submenu we just display a button -->
                            <template is="dom-if" if="{{study.populations}}">
                                <div id="{{prefix}}{{study.id}}" hidden>
                                    <template is="dom-repeat" items="{{study.populations}}" as="popFreq">
                                        <label class="clinical-popFreqName">{{popFreq.title}}</label>
                                        <div class="horizontal layout">
                                            <span>MAF</span>
                                            <span>
                                                    <select name="{{popFreq.id}}Operator" id="{{prefix}}{{study.id}}{{popFreq.id}}Operator" on-change="updateQueryFilters"  class$="{{prefix}}FilterSelect">
                                                        <option value="<" selected><</option>
                                                        <option value="<="><=</option>
                                                        <option value=">">></option>
                                                        <option value=">=">>=</option>
                                                    </select>
                                                </span>
                                            <span>
                                                    <input type="text" value="" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" name="{{study.id}}_{{popFreq.id}}" id="{{prefix}}{{study.id}}{{popFreq.id}}" on-keyup="updateQueryFilters">
                                                </span>
                                        </div>
                                    </template>
                                </div>
                                <br>
                            </template>
                        </template>
                    </div>
                </div>
            </div>


            <!--Protein Substitution Scores filter-->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}}ProteinSubstitutionScoreHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}ProteinSubstitutionScore"
                           aria-expanded="false" aria-controls="{{prefix}}ProteinSubstitutionScore">
                            Impact Filters
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Impact filters"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}ProteinSubstitutionScore" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}ProteinSubstitutionScoreHeading">
                    <div class="panel-body">
                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}SiftDiv" style="cursor: pointer;"></i>&nbsp;Protein Substitution Score</label>

                        <div id="{{prefix}}SiftDiv" hidden>
                            <div style="padding-top: 10px">
                                <label style="font-weight: normal;">SIFT</label><br>
                                <select class="options" name="Sift" id="{{prefix}}SiftValues" style="width: 90px" on-change="checkScore" class$="{{prefix}}FilterSelect">
                                    <option value="score" selected>Score...</option>
                                    <option value="tolerated">Tolerated</option>
                                    <option value="deleterious">Deleterious</option>
                                </select>
                                <select name="siftOperator" id="{{prefix}}SiftOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}SiftInput" name="Sift" on-keyup="updateQueryFilters">
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="Select None in the drop-down list on the left to enable the input of a specific SIFT score threshold. SIFT score takes values in the range [0, infinite[, the lower the values, the more damaging the prediction"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div><br>
                            <div>
                                <label style="font-weight: normal;">Polyphen</label><br>
                                <select class="options" name="Polyphen" id="{{prefix}}PolyphenValues" style="width: 90px" on-change="checkScore" class$="{{prefix}}FilterSelect">
                                    <option value="score" selected>Score...</option>
                                    <option value="benign">Benign</option>
                                    <option value="unknown">Unknown</option>
                                    <option value="possibly damaging">Possibly damaging</option>
                                    <option value="probably damaging">Probably damaging</option>
                                    <option value="possibly damaging,probably damaging">Possibly & Probably damaging</option>
                                </select>
                                <select name="polyphenOperator" id="{{prefix}}PolyphenOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}PolyphenInput" name="Polyphen" on-keyup="updateQueryFilters">

                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="Select None in the drop-down list on the left to enable the input of a specific Polyphen score threshold. Polyphen score takes values in the range [0, 1[, the closer to 2, the more damaging the prediction"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div>

                            <br>
                            <form>
                                <label style="font-weight: normal;">Logical Operator</label>
                                <input type="radio" name="{{prefix}}pss" id="{{prefix}}pssOrRadio" value="or" class$="{{prefix}}FilterRadio" checked disabled on-change="updateQueryFilters" style="margin-left: 10px"> OR<br>
                                <input type="radio" name="{{prefix}}pss" id="{{prefix}}pssAndRadio" value="and" class$="{{prefix}}FilterRadio" disabled on-change="updateQueryFilters" style="margin-left: 102px"> AND<br>
                            </form>
                        </div>
                        <br>

                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}CADDDiv" style="cursor: pointer;"></i>&nbsp;CADD</label>
                        <div id="{{prefix}}CADDDiv" hidden>
                            <div class="block" style="padding-top: 10px">
                                <label>Raw</label>
                                <select name="caddRawOperator" id="{{prefix}}CaddRawOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}CaddRawInput" name="caddRaw" on-keyup="updateQueryFilters">
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="Raw values have relative meaning, with higher values indicating that a variant is more likely to be simulated (or not observed) and therefore more likely to have deleterious effects. If discovering causal variants within an individual, or small groups, of exomes or genomes te use of the scaled CADD score is recommended."><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div>
                            <div class="block">
                                <label>Scaled</label>
                                <select name="caddRScaledOperator" id="{{prefix}}CaddScaledOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}CaddScaledInput" name="caddScaled" on-keyup="updateQueryFilters">
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="A scaled C-score of greater of equal 10 indicates that the substitution is predicted to be within the 10% most deleterious substitutions that you can do to the human genome, a score of greater or equal 20 indicates the 1% most deleterious and so on. If you would like to apply a cutoff on deleteriousness, it is suggested by the CADD authors to put a cutoff somewhere between 10 and 20. Maybe at 15, as this also happens to be the median value for all possible canonical splice site changes and non-synonymous variants"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div>
                        </div>
                        <br>
<!--                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}ImpactDiv" style="cursor: pointer;"></i>&nbsp;Impact</label>
                        <div id={{prefix}}ImpactDiv class="panel-body" hidden>
                            <div>
                                <input type="checkbox" value="Low" on-change="updateQueryFilters" class$="{{prefix}}ImpactCheckBox"> Low<br>
                                <input type="checkbox" value="Moderate" on-change="updateQueryFilters" class$="{{prefix}}ImpactCheckBox"> Moderate<br>
                                <input type="checkbox" value="High" on-change="updateQueryFilters" class$="{{prefix}}ImpactCheckBox"> High<br>
                                <input type="checkbox" value="Modifier" on-change="updateQueryFilters" class$="{{prefix}}ImpactCheckBox"> Modifier

                            </div>
                        </div>
                        <br>-->

<!--                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}MtasterDiv" style="cursor: pointer;"></i>&nbsp;Mutation Taster</label>
                        <div class="panel-body" id="{{prefix}}MtasterDiv" hidden>
                            <div>
                                <input type="checkbox" value="DiseaseCausing" on-change="updateQueryFilters" class$="{{prefix}}MutationTasterCheckBox"> Disease causing<br>
                                <input type="checkbox" value="DiseaseCausingAuto" on-change="updateQueryFilters" class$="{{prefix}}MutationTasterCheckBox"> Disease causing automatic<br>
                                <input type="checkbox" value="Polymorphism" on-change="updateQueryFilters" class$="{{prefix}}MutationTasterCheckBox">Polymorphism<br>
                                <input type="checkbox" value="PolymorphismAuto" on-change="updateQueryFilters" class$="{{prefix}}MutationTasterCheckBox"> Polymorphism automatic
                            </div>
                        </div>
                        <br>-->

                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}EffectDiv" style="cursor: pointer;"></i>&nbsp;Effect (SO)</label>
                        <div class="panel-body clinical-ct-scroll" id="{{prefix}}EffectDiv" hidden>
                            <div class="clinical-ct-tree-view clinical-ct-item">
                                <ul id="consequenceTypeFilter">
                                    <template is="dom-repeat" items="{{consequenceTypes.categories}}" as="category">
                                        <li id="{{prefix}}{{category.title}}">
                                            <!--First check if there is a title for that category-->
                                            <template is="dom-if" if="{{checkTitle(category)}}">
                                                <!--If it is a category, only title is shown as it doesn't have any SO term associated with it-->
                                                <template is="dom-if" if="{{category.isCategory}}">
                                                    <input type="checkbox" on-change="updateConsequenceTypeFilter" class$="{{prefix}}FilterCheckBox"> {{category.title}}
                                                </template>
                                                <!--If it is not a category, SO terms should be shown along with its actual title-->
                                                <template is="dom-if" if="{{!category.isCategory}}">
                                                    <input type="checkbox" id={{prefix}}{{category.name}}" on-change="updateConsequenceTypeFilter" data-id="{{category.name}}" class$="soTermCheckBox {{prefix}}FilterCheckBox">
                                                    <span title="{{item.description}}">
                                                        {{category.title}} (<a href="http://www.sequenceontology.org/browser/current_svn/term/{{category.id}}" target="_blank">{{category.id}}</a>)</span>
                                                </template>
                                            </template>
                                            <!--Title is optional. Consequence type name is taken in case title is not given-->
                                            <template is="dom-if" if="{{!checkTitle(category)}}">
                                                <!--If it is a category, only name is shown as it doesn't have any SO term associated with it-->
                                                <template is="dom-if" if="{{category.isCategory}}">
                                                    <input type="checkbox" on-change="updateConsequenceTypeFilter" class$="{{prefix}}FilterCheckBox"> {{category.name}}
                                                </template>
                                                <!--If it is not a category, SO terms should be shown along with its actual name-->
                                                <template is="dom-if" if="{{!category.isCategory}}">
                                                    <input type="checkbox" id="{{prefix}}{{category.name}}" on-change="updateConsequenceTypeFilter" data-id="{{category.name}}" class$="soTermCheckBox {{prefix}}FilterCheckBox">
                                                    <span title="{{item.description}}">
                                                        {{category.name}} (<a href="http://www.sequenceontology.org/browser/current_svn/term/{{category.id}}" target="_blank">{{category.id}}</a>)</span>
                                                </template>
                                            </template>
                                            <ul>
                                                <template is="dom-repeat" items="{{category.terms}}">
                                                    <li><input type="checkbox" id="{{prefix}}{{item.name}}" data-id="{{item.name}}" on-change="updateConsequenceTypeFilter" class$="soTermCheckBox {{prefix}}FilterCheckBox">
                                                        <span title="{{item.description}}">
                                                    {{item.name}} (<a href="http://www.sequenceontology.org/browser/current_svn/term/{{item.id}}" target="_blank">{{item.id}}</a>)</span></li>
                                                </template>
                                            </ul>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                        <br>
<!--                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}MutPredDiv" style="cursor: pointer;"></i>&nbsp;Mutation prediction</label>
                        <div id="{{prefix}}MutPredDiv" hidden>
                            <input id="{{prefix}}MutationPredGain" class$="form-check-input {{prefix}}RadioInput" type="radio" name="mutationPrediction" value="Gain"> Gain of function <br>
                            <input id="{{prefix}}MutationPredLoss" class$="form-check-input {{prefix}}RadioInput" type="radio" name="mutationPrediction" value="Loss"> Loss of function
                        </div>-->

                    </div>
                </div>

            </div>

            <!--Conservation Scores filter-->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}conservationFilterHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}ConservationFilter" aria-expanded="false" aria-controls="{{prefix}}ConservationFilter">
                            Conservation
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Conservation filters"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}ConservationFilter" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}conservationFilterHeading">
                    <div class="panel-body">
                        <div class="block">
                            <label>PhyloP</label>
                            <select name="phylopOperator" id="{{prefix}}PhylopOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                <option value="<" selected><</option>
                                <option value="<="><=</option>
                                <option value=">">></option>
                                <option value=">=">>=</option>
                            </select>
                            <input type="text" value="" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}PhylopInput" name="phylop" on-keyup="updateQueryFilters">
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Positive PhyloP scores measure conservation which is slower evolution than expected, at sites that are predicted to be conserved. Negative PhyloP scores measure acceleration, which is faster evolution than expected, at sites that are predicted to be fast-evolving. Absolute values of phyloP scores represent -log p-values under a null hypothesis of neutral evolution"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                            </div>
                        </div>
                        <div class="block">
                            <label>PhastCons</label>
                            <select name="phastconsOperator" id="{{prefix}}PhastconsOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                <option value="<" selected><</option>
                                <option value="<="><=</option>
                                <option value=">">></option>
                                <option value=">=">>=</option>
                            </select>
                            <input type="text" value="" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}PhastconsInput" name="phastCons" on-keyup="updateQueryFilters">
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="PhastCons estimates the probability that each nucleotide belongs to a conserved element. The phastCons scores represent probabilities of negative selection and range between 0 and 1."><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                            </div>
                        </div>
                        <div class="block">
                            <label>Gerp</label>
                            <select name="gerpOperator" id="{{prefix}}GerpOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                <option value="<" selected><</option>
                                <option value="<="><=</option>
                                <option value=">">></option>
                                <option value=">=">>=</option>
                            </select>
                            <input type="text" value="" class$="clinical-custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}GerpInput" name="gerp" on-keyup="updateQueryFilters">
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Positive scores represent a substitution deficit (i.e., fewer substitutions than the average neutral site) and thus indicate that a site may be under evolutionary constraint. Negative scores indicate that a site is probably evolving neutrally. Some authors suggest that a score threshold of 2 provides high sensitivity while still strongly enriching for truly constrained sites"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                            </div>
                        </div>
                        <form style="padding-top: 10px">
                            <label style="font-weight: normal;">Logical Operator</label>
                            <input type="radio" name="{{prefix}}conservation" id="{{prefix}}conservationOrRadio" value="or" class$="{{prefix}}FilterRadio" checked disabled on-change="updateQueryFilters" style="margin-left: 10px"> OR<br>
                            <input type="radio" name="{{prefix}}conservation" id="{{prefix}}conservationAndRadio" value="and" class$="{{prefix}}FilterRadio" disabled on-change="updateQueryFilters" style="margin-left: 102px"> AND<br>
                        </form>

                    </div>
                </div>
            </div>

            <!-- Disease Databases -->
         <!--   <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}DisDBHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}DisDB" aria-expanded="false" aria-controls="{{prefix}}DisDB">
                            Disease Databases
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Disease database filters"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}DisDB" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}DisDBHeading">
                    <div class="panel-body">
                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}CosmicDiv" style="cursor: pointer;"></i>&nbsp;Cosmic</label>
                        <div class="panel-body" id="{{prefix}}CosmicDiv" hidden></div>
                        <br>
                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}ClinvarDiv" style="cursor: pointer;"></i>&nbsp;Clinvar</label>
                        <div class="panel-body" id="{{prefix}}ClinvarDiv" hidden></div>
                        <br>
                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}OrphanetDiv" style="cursor: pointer;"></i>&nbsp;Orphanet</label>
                        <div class="panel-body" id="{{prefix}}OrphanetDiv" hidden></div>
                        <br>
                        <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}HGMDDiv" style="cursor: pointer;"></i>&nbsp;HGMD</label>
                        <div class="panel-body" id="{{prefix}}HGMDDiv" hidden></div>
                    </div>
                </div>
            </div>
-->


            <!-- Modal dialog for Analysis Browser-->
            <div class="modal fade" id="{{prefix}}AnalysisBrowser" tabindex="-1" role="dialog"
                 aria-labelledby="sampleBrowserLabel">
                <div class="modal-dialog modal-sm" role="document" style="width: 1200px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="{{prefix}}AnalysisBrowserLabel">Analysis Selector</h4>
                        </div>
                        <div class="modal-body" style="height: 750px">
                            <variant-clinical-selector opencga-client="{{opencgaClient}}" analysis-selected="{{analysisSelected}}" study="{{study}}" analysis-modal="{{analysisModal}}" show-pedigree="{{showPedigree}}"></variant-clinical-selector>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-dismiss="modal" on-click="loadAnalysis">OK</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </template>

    <script>
        class VariantClinicalFilter extends Polymer.Element {
            static get is() { return 'variant-clinical-filter'; }
            static get properties() {
                return {
                    project: {
                        type: Object
                    },
                    study: {
                        type: Object,
                        observer: 'updateDifferentStudies'
                    },
                    studies: {
                        type: Array,
                        observer: 'updateDifferentStudies'
                    },
                    opencgaClient: {
                        type: Object
                    },
                    config: {
                        type: Object
                    },
                    populationFrequencies: {
                        type: Object
                    },
                    consequenceTypes: {
                        type: Object
                    },
                    mode: {
                        type: String,
                        value: "browser",
                        observer: '_updateMode'
                    },
                    query: {
                        type: Object,
                        notify: true,
                        observer: 'onQueryUpdate'
                    },
                    search: {
                        type: Object,
                        notify: true
                    },
                    samples: {
                        type: Array,
                        notify: true,
                        observer: "sampleChanged"
                    },
                    segregation: {
                        type: String,
                        value: "Select Segregation",
                        observer: "segregate"
                    },
                    analysisSelected: {
                        type: Object,
                        notify: true // This notification will be removed (now is used in variant-clinical)
                    },
                    analysisModal: {
                        type: Boolean,
                        notify: true
                    }
                }
            }
            constructor() {
                super();
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }
            ready() {
                super.ready();
                if (UtilsNew.isEmpty(this.prefix)) {
                    this.prefix = "clinicalFilter" + Utils.randomString(6);
                }
                this.sampleGenotypesObj = {};
                this.set('query', {});
                //this.query = {};

                this.isFamilyAnalysis = true;
                this.set('panelList', PANELS);
                this.showPedigree = true;
            }
            onSearch() {
                //this.search = this.query;
                this.set('search', this.query);
            }
            onQueryUpdate() {
                if (this._reset) {
                    console.log("onQueryUpdate: calling to 'renderQueryFilters()'")
                    this.renderQueryFilters();
                } else {
                    this._reset = true;
                }
            }
            handleCollapseAction(e) {
                let elem = PolymerUtils.getElementById(e.target.dataId);
                elem.hidden = !elem.hidden;
                if (elem.hidden) {
                    e.target.className = "fa fa-plus";
                } else {
                    e.target.className = "fa fa-minus";
                }
            }
            checkTitle(consequenceType) {
                return UtilsNew.isNotUndefinedOrNull(consequenceType.title);
            }
            moreStudiesPresent(studies) {
                if (UtilsNew.isNotUndefined(studies)) {
                    return studies.length > 1;
                } else {
                    return false;
                }
            }

            updateDifferentStudies() {
                let differentStudies = [];
                if (UtilsNew.isNotUndefined(this.study) && UtilsNew.isNotUndefined(this.studies)) {
                    for (let i = 0; i < this.studies.length; i++) {
                        if (this.study.alias != this.studies[i].alias) {
                            differentStudies.push(this.studies[i]);
                        }
                    }
                    this.differentStudies = differentStudies;
                }
            }
            updateConsequenceTypeFilter(e) {
                // TO DO: To migrate to polymer utils
                let soTerms = [];
                if (e.target.parentNode.id != "") {
                    $("#" + e.target.parentNode.id).children('ul').children('li').children('input').prop("checked", e.target.checked);
                }
                let selected = PolymerUtils.querySelectorAll('.soTermCheckBox:checked');
                //let selected = $('.soTermCheckBox:checked');
                for (let i = 0; i < selected.length; i++) {
                    soTerms.push(selected[i].dataId);
                }
                this.set('ct', soTerms);
                this.updateQueryFilters();
            }
            checkScore(e) {
                if (e.target.value == "score") {
                    PolymerUtils.setPropertyById(this.prefix + e.target.name + "Input" , "disabled", false);
                    PolymerUtils.setPropertyById(this.prefix + e.target.name + "Operator" , "disabled", false);
                } else {
                    PolymerUtils.setPropertyById(this.prefix + e.target.name + "Input" , "value", "");
                    PolymerUtils.setPropertyById(this.prefix + e.target.name + "Operator" , "value", "<");
                    PolymerUtils.setPropertyById(this.prefix + e.target.name + "Input" , "disabled", true);
                    PolymerUtils.setPropertyById(this.prefix + e.target.name + "Operator" , "disabled", true);
                }
                this.updateQueryFilters();
            }
            clear() {
                // This will trigger the event that call to renderQueryFilters
                this.set('query', {});
                //this.query = {};

                // This refresh the variant main grid
                this.set('search', {});
                //this.search = {};
            }
            renderQueryFilters() {
                // Empty everything before rendering
                this._clearHtmlDom();

                // Position
                if (UtilsNew.isNotUndefined(this.query.region)){
                    PolymerUtils.setPropertyById(this.prefix + "LocationTextarea", "value", this.query.region);
                }

                // XRefs, Gene and Variant Ids
                if (UtilsNew.isNotUndefined(this.query["annot-xref"])){
                    PolymerUtils.setPropertyById(this.prefix + "FeatureTextarea", "value", this.query["annot-xref"]);
                } else if (UtilsNew.isNotUndefined(this.query.gene)) {
                    PolymerUtils.setPropertyById(this.prefix + "FeatureTextarea", "value", this.query.gene);
                } else if (UtilsNew.isNotUndefined(this.query.ids)) {
                    PolymerUtils.setPropertyById(this.prefix + "FeatureTextarea", "value", this.query.ids);
                }

                // Type -> DOES NOT EXIST IN THIS COMPONENT
/*                if (UtilsNew.isNotUndefined(this.query.type)){
                    let types = this.query.type.split(",");
                    //let checkBoxes = this.$$("#" + this.prefix + "Type").querySelectorAll("input");
                    let checkBoxes = PolymerUtils.querySelectorAll("input", this.prefix + "Type");
                    for (let i = 0; i < types.length; i++) {
                        for (let j = 0; j < checkBoxes.length; j++) {
                            if (checkBoxes[j].value == types[i]) {
                                checkBoxes[j].checked = true;
                            }
                        }
                    }
                }*/

                // Population Freqs
                let pfArray = [];
                if (UtilsNew.isNotUndefined(this.query["alternate_frequency"])){
                    pfArray = this.query["alternate_frequency"].split(new RegExp("[,;]"));
                }
                if (UtilsNew.isNotUndefined(this.populationFrequencies) && UtilsNew.isNotUndefined(this.populationFrequencies.studies) && this.populationFrequencies.studies.length > 0) {
                    for (let i = 0; i < this.populationFrequencies.studies.length; i++) {
                        let study = this.populationFrequencies.studies[i].id;
                        for (let j = 0; j < this.populationFrequencies.studies[i].populations.length; j++) {
                            let population = this.populationFrequencies.studies[i].populations[j].id;
                            if (pfArray.length > 0) {
                                for (let k = 0; k < pfArray.length; k++) {
                                    let pf = pfArray[k];
                                    if (pf.startsWith(study + ":" + population)) {
                                        PolymerUtils.setPropertyById(this.prefix + study + population, "value", pf.split(/[<=>]+/)[1]);
                                        PolymerUtils.setPropertyById(this.prefix + study + population + "Operator", "value", pf.split(/[-A-Za-z0-9._:]+/)[1]);
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }

                // Protein Substitution scores
                if (UtilsNew.isNotUndefined(this.query["protein_substitution"])){
                    let pss = this.query["protein_substitution"].split(new RegExp("[,;]"));
                    if (pss.length > 0) {
                        for (let i = 0; i < pss.length; i++) {
                            if (pss[i].startsWith("sift")) {
                                let value = pss[i].split("sift")[1];
                                if (value.startsWith("<") || value.startsWith(">")) {
                                    PolymerUtils.setPropertyById(this.prefix + "SiftInput" , "value", value.split(/[<=>]+/)[1]);
                                    PolymerUtils.setPropertyById(this.prefix + "SiftOperator" , "value", value.split(/[-0-9.]+/)[0]);
                                } else {
                                    PolymerUtils.setPropertyById(this.prefix + "SiftValues", "value", value.split('==')[1]);
                                }
                                PolymerUtils.setAttribute(this.prefix + "SiftInput", "disabled", !(value.startsWith("<") || value.startsWith(">")));
                                PolymerUtils.setAttribute(this.prefix + "SiftOperator", "disabled", !(value.startsWith("<") || value.startsWith(">")));
                            } else if (pss[i].startsWith("polyphen")) {
                                let value = pss[i].split("polyphen")[1];
                                if (value.startsWith("<") || value.startsWith(">")) {
                                    PolymerUtils.setPropertyById(this.prefix + "PolyphenInput", "value", value.split(/[<=>]+/)[1]);
                                    PolymerUtils.setPropertyById(this.prefix + "PolyphenOperator", "value", value.split(/[-0-9.]+/)[0]);
                                } else {
                                    PolymerUtils.setPropertyById(this.prefix + "PolyphenValues", "value", value.split('==')[1]);
                                }
                                PolymerUtils.setAttribute(this.prefix + "PolyphenInput", "disabled", !(value.startsWith("<") || value.startsWith(">")));
                                PolymerUtils.setAttribute(this.prefix + "PolyphenOperator", "disabled", !(value.startsWith("<") || value.startsWith(">")));
                            }
                        }
                    }
                }

                // Cadd scores
                if (UtilsNew.isNotUndefined(this.query["annot-functional-score"])) {
                    let fields = this.query["annot-functional-score"].split(new RegExp("[,;]"));
                    for (let i = 0; i < fields.length; i++) {
                        let source = fields[i].split(/[<=>]+/)[0];
                        switch(source) {
                            case "cadd_raw":
                                PolymerUtils.setPropertyById(this.prefix + "CaddRawInput", "value", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setPropertyById(this.prefix + "CaddRawOperator", "value", fields[i].split(/[-A-Za-z0-9_]+/)[1]);
                                break;
                            case "cadd_scaled":
                                PolymerUtils.setPropertyById(this.prefix + "CaddScaledInput", "value", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setPropertyById(this.prefix + "CaddScaledOperator", "value", fields[i].split(/[-A-Za-z0-9_]+/)[1]);
                                break;
                        }
                    }
                }

                // Conservation
                if (UtilsNew.isNotUndefined(this.query.conservation)) {
                    let fields = this.query.conservation.split(new RegExp("[,;]"));
                    for (let i = 0; i < fields.length; i++) {
                        let source = fields[i].split(/[<=>]+/)[0];
                        switch(source) {
                            case "phylop":
                                PolymerUtils.setPropertyById(this.prefix + "PhylopInput", "value", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setPropertyById(this.prefix + "PhylopOperator", "value", fields[i].split(/[-A-Za-z0-9]+/)[1]);
                                break;
                            case "phastCons":
                                PolymerUtils.setPropertyById(this.prefix + "PhastconsInput", "value", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setPropertyById(this.prefix + "PhastconsOperator", "value", fields[i].split(/[-A-Za-z0-9]+/)[1]);
                                break;
                            case "gerp":
                                PolymerUtils.setPropertyById(this.prefix + "GerpInput", "value", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setPropertyById(this.prefix + "GerpOperator", "value", fields[i].split(/[-A-Za-z0-9]+/)[1]);
                                break;
                        }
                    }
                }

                // Consequence Type
                if (UtilsNew.isNotUndefined(this.query["annot-ct"])) {
                    let types = this.query["annot-ct"].split(",");
                    let checkboxes = PolymerUtils.querySelectorAll("li input", "consequenceTypeFilter");
                    for (let i = 0; i < types.length; i++) {
                        for (let j = 0; j < checkBoxes.length; j++) {
                            if (checkBoxes[j].dataId == types[i]) {
                                checkBoxes[j].checked = true;
                            }
                        }
                    }
                } else {
                    this.set('ct', []); // Clearing the consequence type that is taken by this.query
                }

                // Gene Ontology and Human Phenotype Ontology
                if (UtilsNew.isNotUndefined(this.query["annot-go"])) {
                    PolymerUtils.setPropertyById(this.prefix + "GeneOntologyTextarea", "value", this.query["annot-go"]);
                }
                if (UtilsNew.isNotUndefined(this.query["annot-hpo"])) {
                    PolymerUtils.setPropertyById(this.prefix + "HumanPhenotypeOntologyTextarea", "value", this.query["annot-hpo"]);
                }
            }
            updatePanel(){
                console.log(this);
                debugger;
                let panelname = PolymerUtils.getPropertyById(this.prefix + "PanelApps", "value");
                for(var i = 0; i < this.panelList.length ; i++){
                    if(this.panelList[i].name == panelname){
                        let panel = this.panelList[i];
                        PolymerUtils.setPropertyById(this.prefix + "PanelAppsTextarea", "value", panel.genes);
                        break;
                    }
                }
                this.updateQueryFilters();
            }
            sortPanelApp(a, b) {
                if (a.title === b.title) {
                    return 0;
                }
                return a.title < b.title ? -1 : 1;
            }
            updateQueryFilters() {
                let _filters = {};
                // Adding sample genotypes filter
                if (UtilsNew.isNotEmpty(this.sampleGenotypes)) {
                    _filters.genotype = this.sampleGenotypes;
                }

                // Regions
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "LocationTextarea")) {
                    _filters.region = PolymerUtils.getPropertyById(this.prefix + "LocationTextarea", "value");
                }

                // Features: Gene, SNP ID
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "FeatureTextarea")) {
                    if (PolymerUtils.getPropertyById(this.prefix + "FeatureTextarea", "value").startsWith("rs") || PolymerUtils.getPropertyById(this.prefix + "FeatureTextarea", "value").split(':').length > 2){
                        _filters["annot-xref"] = PolymerUtils.getPropertyById(this.prefix + "FeatureTextarea", "value");
                    } else {
                        _filters["annot-xref"] = PolymerUtils.getPropertyById(this.prefix + "FeatureTextarea", "value").toUpperCase();
                    }
                }

                // Biotype
                if (PolymerUtils.getElementById(this.prefix + "GeneBiotypes").selectedOptions.length >0) {
                    let _auxBiotype = [];
                    let _allElements = PolymerUtils.getElementById(this.prefix + "GeneBiotypes").selectedOptions;
                    for (let i = 0; i < _allElements.length; i++) {
                        _auxBiotype.push(_allElements[i].value);
                    }

                    _filters["annot-biotype"] = _auxBiotype.join(",");
                }

                // Panel - annot-panel
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "PanelApps") || PolymerUtils.isNotEmptyValueById(this.prefix + "PanelAppsTextarea")){
                    _filters["gene"] = PolymerUtils.getPropertyById(this.prefix + "PanelAppsTextarea", "value");
                }


                // Type
    //            let types = this.$$("#" + this.prefix + "Type").querySelectorAll("input:checked");
    //            let typesAux = [];
    //            if (types.length > 0) {
    //                for (let i = 0; i < types.length; i++) {
    //                    typesAux.push(types[i].value);
    //                }
    //                _filters.type = typesAux.join(',');
    //            }

                // Population Frequencies
                // Population minor allele frequency: {study}:{population}[<|>|<=|>=]{number}
                let popFreq = [];
                if (UtilsNew.isNotUndefined(this.populationFrequencies) && UtilsNew.isNotUndefined(this.populationFrequencies.studies) && this.populationFrequencies.studies.length > 0){
                    for (let i = 0; i < this.populationFrequencies.studies.length; i++) {
                        let study = this.populationFrequencies.studies[i].id;
                        for (let j = 0; j < this.populationFrequencies.studies[i].populations.length; j++) {
                            let population = this.populationFrequencies.studies[i].populations[j].id;
                            if (PolymerUtils.isNotEmptyValueById(this.prefix + study + population) || PolymerUtils.getPropertyById(this.prefix + study + population + "Operator", "value") != "<"){
                                let operator = PolymerUtils.getPropertyById(this.prefix + study + population + "Operator", "value");
                                let pf = study + ":" + population + operator + PolymerUtils.getPropertyById(this.prefix + study + population, "value");
                                popFreq.push(pf);
                            }
                        }
                    }
                }
                if (popFreq.length > 0) {
                    _filters["alternate_frequency"] = popFreq.join(';');
                }

                // Protein Substitution scores
                let pss = [];
                let sift = "";
                if (PolymerUtils.getPropertyById(this.prefix + "SiftValues", "value") === "score" && PolymerUtils.isNotEmptyValueById(this.prefix + "SiftInput") || PolymerUtils.getPropertyById(this.prefix + "SiftOperator", "value") != "<") {
                    sift = "sift" + PolymerUtils.getPropertyById(this.prefix + "SiftOperator", "value") + PolymerUtils.getPropertyById(this.prefix + "SiftInput", "value");
                    pss.push(sift);
                } else if (PolymerUtils.getPropertyById(this.prefix + "SiftValues", "value") != "score") {
                    sift = "sift" + "==" + PolymerUtils.getPropertyById(this.prefix + "SiftValues", "value");
                    pss.push(sift);
                }
                let polyphen = "";
                if (PolymerUtils.getPropertyById(this.prefix + "PolyphenValues", "value") == "score" && PolymerUtils.isNotEmptyValueById(this.prefix + "PolyphenInput") || PolymerUtils.getPropertyById(this.prefix + "PolyphenOperator", "value") != "<") {
                    polyphen = "polyphen" + PolymerUtils.getPropertyById(this.prefix + "PolyphenOperator", "value") + PolymerUtils.getPropertyById(this.prefix + "PolyphenInput", "value");
                    pss.push(polyphen);
                } else if (PolymerUtils.getPropertyById(this.prefix + "PolyphenValues", "value") != "score") {
                    let value = PolymerUtils.getPropertyById(this.prefix + "PolyphenValues", "value");
                    let polyphenValues = value.split(',');
                    for (let i = 0; i < polyphenValues.length; i++) {
                        polyphen = "polyphen" + "==" + polyphenValues[i];
                        pss.push(polyphen);
                    }
                }
                if ((PolymerUtils.isNotEmptyValueById(this.prefix + "SiftInput") && PolymerUtils.isNotEmptyValueById(this.prefix + "PolyphenInput")) ||
                    (PolymerUtils.getPropertyById(this.prefix + "SiftValues", "value") != "score" && PolymerUtils.isNotEmptyValueById(this.prefix + "PolyphenInput")) ||
                    (PolymerUtils.isNotEmptyValueById(this.prefix + "SiftInput") && PolymerUtils.getPropertyById(this.prefix + "PolyphenValues", "value") != "score") ||
                    (PolymerUtils.getPropertyById(this.prefix + "SiftValues", "value") != "score" && PolymerUtils.getPropertyById(this.prefix + "PolyphenValues", "value") != "score")){
                        let pssElements = PolymerUtils.querySelectorAll("input[name=" + this.prefix + "pss]");
                        pssElements.forEach(function (item) {
                            PolymerUtils.removeAttribute(item.id, "disabled");
                        });
                }
                else {
                    let pssElements = PolymerUtils.querySelectorAll("input[name=" + this.prefix + "pss]");
                    pssElements.forEach(function (item) {
                        PolymerUtils.setAttribute(item.id, "disabled", true);
                    });

                }
                if (pss.length > 0) {
                    let filter = PolymerUtils.querySelector("input[name=" + this.prefix + "pss]:checked").value;
                    if (filter == "and") {
                        _filters.protein_substitution = pss.join(';');
                    } else {
                        _filters.protein_substitution = pss.join(',');
                    }
                }

                // Conservation
                let conserArr = [];
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "PhylopInput") || PolymerUtils.getPropertyById(this.prefix + "PhylopOperator", "value") != "<") {
                    let phylop = "phylop" + PolymerUtils.getPropertyById(this.prefix + "PhylopOperator", "value") + PolymerUtils.getPropertyById(this.prefix + "PhylopInput", "value")
                    conserArr.push(phylop);
                }
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "PhastconsInput") || PolymerUtils.getPropertyById(this.prefix + "PhastconsOperator", "value") != "<") {
                    let phastCons = "phastCons" + PolymerUtils.getPropertyById(this.prefix + "PhastconsOperator", "value") + PolymerUtils.getPropertyById(this.prefix + "PhastconsInput", "value");
                    conserArr.push(phastCons);
                }
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "GerpInput") || PolymerUtils.getPropertyById(this.prefix + "GerpOperator", "value") != "<") {
                    let gerp = "gerp" + PolymerUtils.getPropertyById(this.prefix + "GerpOperator", "value") + PolymerUtils.getPropertyById(this.prefix + "GerpInput", "value");
                    conserArr.push(gerp);
                }
                if ((PolymerUtils.isNotEmptyValueById(this.prefix + "PhylopInput") && PolymerUtils.isNotEmptyValueById(this.prefix + "PhastconsInput")) ||
                    (PolymerUtils.isNotEmptyValueById(this.prefix + "PhylopInput") && PolymerUtils.isNotEmptyValueById(this.prefix + "GerpInput")) ||
                    (PolymerUtils.isNotEmptyValueById(this.prefix + "PhastconsInput") && PolymerUtils.isNotEmptyValueById(this.prefix + "GerpInput"))) {
                        let conservationElements = PolymerUtils.querySelectorAll("input[name=" + this.prefix + "conservation]");
                        conservationElements.forEach(function (item) {
                            PolymerUtils.removeAttribute(item.id, "disabled");
                        });
                }
                else {
                    let conservationElements = PolymerUtils.querySelectorAll("input[name=" + this.prefix + "conservation]");
                    conservationElements.forEach(function (item) {
                        PolymerUtils.setAttribute(item.id, "disabled", true);
                    });
                }

                if (conserArr.length > 0) {
                    let filter = PolymerUtils.querySelector("input[name=" + this.prefix + "conservation]:checked").value;
                    if (filter == "and") {
                        _filters.conservation = conserArr.join(';');
                    } else {
                        _filters.conservation = conserArr.join(',');
                    }
                }

                // Consequence Type
                if (UtilsNew.isNotUndefined(this.ct) && this.ct.length > 0) {
                    _filters["annot-ct"]= this.ct.join(',');
                }

                // Gene Ontology and Human Phenotype Ontology
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "HumanPhenotypeOntologyTextarea")) {
                    _filters["annot-hpo"] = PolymerUtils.getElementById(this.prefix + "HumanPhenotypeOntologyTextarea", "value");
                }
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "GeneOntologyTextarea")){
                    _filters["annot-go"] = PolymerUtils.getElementById(this.prefix + "GeneOntologyTextarea", "value");
                }
    //            if (this.$$("#" + this.prefix + "TraitsTextarea").value != "") {
    //                _filters["traits"] = this.$$("#" + this.prefix + "TraitsTextarea").value;
    //            }

                // Cadd scores
                let cadd = [];
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "CaddRawInput") || PolymerUtils.getPropertyById(this.prefix + "CaddRawOperator","value") != "<") {
                    let raw = "cadd_raw" + PolymerUtils.getPropertyById(this.prefix + "CaddRawOperator","value") + PolymerUtils.getPropertyById(this.prefix + "CaddRawInput","value");
                    cadd.push(raw);
                }
                if (PolymerUtils.isNotEmptyValueById(this.prefix + "CaddScaledInput") || PolymerUtils.getPropertyById(this.prefix + "CaddScaledOperator","value") != "<") {
                    let scaled = "cadd_scaled" + PolymerUtils.getPropertyById(this.prefix + "CaddScaledOperator","value") + PolymerUtils.getPropertyById(this.prefix + "CaddScaledInput","value");
                    cadd.push(scaled);
                }
                if (cadd.length > 0) {
                    _filters["annot-functional-score"] = cadd.join(',');
                }

                // To prevent to call renderQueryFilters we set this to false
                this._reset = false;
                this.set('query', _filters);
                this._reset = true;
            }
            // Exclusive for prioritization
            refreshSegregationTable() {
    //                this.samples = [];
            }
            selectAnalysisType(e) {
                e.preventDefault();
                this.analysisType = e.target.value;
                this.isFamilyAnalysis = this.isCancerAnalysis = false;
                if (this.analysisType === "family") {
                    this.isFamilyAnalysis = true;
                } else {
                    this.isCancerAnalysis = true;
                }
            }
            selectSegregation(e) {
                e.preventDefault();
                this.segregation = e.target.innerHTML;
            }
            sampleGenotypeSelected(e) {
                // TODO coordinate manual selection and event driven selection
    //                if (this.sampleGenotypes != "") {
    //                    let genotypes = this.sampleGenotypes.split(';');
    //                    this.sampleGenotypesObj = genotypes.reduce(function(result, item) {
    //                        debugger
    //                        let items = item.split(':');
    //                        result[items[0]] = {};
    //                        result[items[0]][items[1]] = true;
    //                        return result;
    //                    }, {});
    //                }
                if (UtilsNew.isNotUndefined(e)) {
                    if (UtilsNew.isUndefined(this.sampleGenotypesObj[e.target.dataId])) {
                        this.sampleGenotypesObj[e.target.dataId] = {};
                    }
                    this.sampleGenotypesObj[e.target.dataId][e.target.defaultValue] = e.target.checked;

                    let arr = [];
                    for (let sampleName in this.sampleGenotypesObj) {
                        let gts = [];
                        for (let sampleGT in this.sampleGenotypesObj[sampleName]) {
                            if (this.sampleGenotypesObj[sampleName][sampleGT] == true) {
                                gts.push(sampleGT.replace('/', '|'));
                            }
                        }
                        if (gts.length > 0) {
                            arr.push(sampleName + ':' + gts.join(','));
                        }
                    }
                    this.sampleGenotypes = arr.join(';');
                    if (arr.length > 0) {
                        this._filters.genoType = arr.join(';');
                    } else {
                        delete this._filters.genoType;
                    }
                    this._filtersCount = Object.keys(this._filters).length;
                }
            }
            sampleChanged() {
                this.segregation = "Select Segregation";
            }
            segregate() { // In order to make this function to work, build segregationTable table
                let cell;
                let samples = this.samples;

                /*if (UtilsNew.isNotUndefined(samples) && samples != "" && samples.length >= 3) {
                    if (this.segregation == "Autosomal Dominant") {
                        for (let i = 0; i < samples.length; i++) {
                            let index = i + 1;
                            if (samples[i].status == "unaffected") {
                                cell = $("#segregationTable tr:eq(" + index + ") td:eq(1)")[0].children[0];
                                $(cell).prop("checked", true);
                            } else if (samples[i].status == "affected") {
                                for (let j = 0; j < samples.length; j++) {
                                    if (i == j) {
                                        continue;
                                    }
                                    if (samples[j].status == "unaffected" && samples[j].memberCode == "D" || samples[j].memberCode == "S") {
                                        cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                        $(cell).prop("checked", true);
                                    } else if (samples[j].status == "affected" && samples[i].memberCode == "F") {
                                        if (i == 0 && j == 1) {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        } else if (i == 0 && j != 1) {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                            $(cell).prop("checked", true);
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(3)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        }
                                    } else if (samples[j].status == "affected" && samples[i].memberCode == "M") {
                                        if (i == 1 && j == 0) {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        } else if (i == 1 && j != 0) {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                            $(cell).prop("checked", true);
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(3)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        }
                                    } else if (samples[j].status == "affected" && samples[i].memberCode == "D" || samples[i].memberCode == "S") {
                                        cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                        $(cell).prop("checked", true);
                                        if (samples[j + 1].status == "affected" && samples[j + 1].memberCode == "M") {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(3)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        }
                                    }
                                }
                            }
                        }
                        this.sampleGenotypeManual();
                    }
                }*/
            }
            sampleGenotypeManual() {
                let arr = [];
                if (this.samples != "" && this.samples.length > 1) {
                    for (let i = 0; i < this.samples.length; i++) {
                        let sample = this.samples[i].name;
                        let gts = [];
                        let children = $("#" + sample).children();
                        for (let j = 0; j < children.length; j++) {
                            let child = $("#" + sample).children()[j];
                            let input = $(child).children()[0];
                            let cb = $(input)[0];
                            if ($(cb).is(':checked')) {
                                gts.push($(cb).val().replace('/', '|'));
                            }
                        }
                        if (gts.length > 0) {
                            arr.push(sample + ':' + gts.join(','));
                        }
                    }
                }
                this.sampleGenotypes = arr.join(';');
            }
            _clearHtmlDom() {
                // Empty everything before rendering
                PolymerUtils.setPropertyByClassName(this.prefix + "FilterSelect", "selectedIndex", 0);
                PolymerUtils.removeAttributeByclass("FilterSelect", "disabled");
                PolymerUtils.setPropertyByClassName(this.prefix + "FilterTextInput", "value", "");
                PolymerUtils.removeAttributeByclass("FilterTextInput", "disabled");
                PolymerUtils.setPropertyByClassName(this.prefix + "FilterCheckBox", "checked", false);
                PolymerUtils.setPropertyByClassName(this.prefix + "FilterRadio", "checked", false);
                $("." + this.prefix + "FilterRadio").filter('[value="or"]').prop('checked', true);
                PolymerUtils.removeAttributeByclass("FilterRadio", "disabled");
            }
            _updateMode() {

                switch (this.mode) {
                    case "browser":
                        this.isBrowserMode = true;
                        break;
                    case "prioritization":
                        this.isPrioritizationMode = true;
                        break;
                    case "analysis":
                        this.isAnalysisMode = true;
                        break;
                    default:
                        this.isBrowserMode = true;
                        break;
                }
            }
            loadAnalysis(e){
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                this.currentAnalysisID = this.analysisSelected.analysisID;
                this.samples = this.analysisSelected.sampleList; // Samples are notified to variant-prioritization-view
                PolymerUtils.show(this.prefix + "analysisSelectedDiv");


            }
            showClinicalSelector(e){
                e.preventDefault();
                if (UtilsNew.isUndefined(this.analysisModal)){
                    this.analysisModal = true;
                }
                else {
                    this.analysisModal = ! this.analysisModal;
                }
                $("#" + this.prefix + "AnalysisBrowser").modal('show');
            }
        }
        customElements.define(VariantClinicalFilter.is, VariantClinicalFilter);
    </script>
</dom-module>
