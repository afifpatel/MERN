<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<link rel="import" href="../../opencga-message-dialog.html">
<link rel="import" href="../../../commons/variant-modal-ontology.html">

<dom-module id="variant-clinical-upload">
    <template>
        <style include="jso-styles">
            .clinical-title {
                margin: 30px 5px 25px -40px;
            }

            .infoHpo {
                margin-top: 15px;
            }

        </style>

        <div class="col-md-12">
            <div style="width: 60%; margin: 0px 0px 0px 90px">
                <form id="{{prefix}}uploadForm" class="form-horizontal" data-toggle="validator" data-feedback='{"success": "fa-check", "error": "fa-times"}' role="form">
                    <h3 class="clinical-title">Patient Information</h3>
                    <!-- GENERAL INFORMATION -->
                    <!-- Individual ID -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}patientID" class="col-xs-2 col-form-label">Patient ID</label>
                        <div class="col-xs-6">
                            <div class="input-group">
                                <input type="text" class$="form-control {{prefix}}TextInput codeDis"
                                       id="{{prefix}}patientID" name="patientID"
                                       placeholder="ID or clinical record number" maxlength="75" required data-error=""
                                       pattern=".+">
                                <span class="input-group-addon btn btn-primary" on-click="searchIndividual">
                                    <i class="fa fa-search" aria-hidden="true"></i>
                                </span>
                            </div>
                            <span class="fa form-control-feedback" aria-hidden="true"
                                  style="padding-right:60px; z-index:5"></span>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>
                    <!-- CHROMOSOMAL GENDER -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}chromosomalGender" class="col-xs-2 col-form-label">Chromosomal
                            Gender</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput codeDis" id="{{prefix}}chromosomalGender"
                                    name="chromosomalGender" required>
                                <option></option>
                                <template is="dom-repeat" items="{{config.chromosomal_gender}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_chromosomalGender"></div>
                        </div>
                    </div>
                    <!-- STATUS -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}status" class="col-xs-2 col-form-label">Affectation Status</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput codeDis" id="{{prefix}}status"
                                    name="status" required>
                                <option></option>
                                <template is="dom-repeat" items="{{config.status}}">
                                    <option value="{{item.id}}">{{item.title}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_status"></div>
                        </div>
                    </div>
                    <!-- LIFE STATUS -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}lifeStatus" class="col-xs-2 col-form-label">Life Status</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput codeDis" id="{{prefix}}lifeStatus"
                                    name="lifeStatus" required>
                                <option></option>
                                <template is="dom-repeat" items="{{config.life_status}}">
                                    <option value="{{item.id}}">{{item.title}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_lifeStatus"></div>
                        </div>
                    </div>
                    <!-- YEAR OF BIRTH -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}birthYear" class="col-xs-2 col-form-label">Year of Birth</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput codeDis" id="{{prefix}}birthYear"
                                    name="birthYear" required on-change="checkYears">
                                <option></option>
                                <template is="dom-repeat" items="{{yearsBirth}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_birthYear"></div>
                        </div>
                    </div>

                    <!-- BIRTH PLACE -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}birthPlace" class="col-xs-2 col-form-label">Birth Place</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput codeDis" id="{{prefix}}birthPlace"
                                    name="birthPlace" required on-change="updateSelect">
                                <option></option>
                                <template is="dom-repeat" items="{{config.countries}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_birthPlace"></div>
                        </div>
                    </div>

                    <!-- OTHER COUNTRY (TEXT INPUT if country selected is not in the list -->
                    <div class="form-group row has-feedback" id="otherCountryDiv" style="display:none">
                        <label for="{{prefix}}otherCountry" class="col-xs-2 col-form-label"></label>
                        <div class="col-xs-3">
                            <input type="text" class$="form-control {{prefix}}TextInput codeDis"
                                   id="{{prefix}}otherCountry" name="otherCountry" placeholder="Introduce country"
                                   maxlength="75" required
                                   data-error="Mandatory country. Only a-z characteres and spaces are allowed"
                                   pattern="^[A-Za-z]+((\\s)?([A-Za-z])+)+$">
                            <span class="fa form-control-feedback" aria-hidden="true"></span>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>

                    <!-- BIRTH PLACE (PROVINCE) -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}birthPlaceRegion" class="col-xs-2 col-form-label">Birth Place
                            (province)</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput codeDis" id="{{prefix}}birthPlaceRegion"
                                    name="birthPlaceRegion" required>
                                <option></option>
                                <template is="dom-repeat" items="{{config.province}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>

                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_birthPlaceRegion"></div>
                        </div>
                    </div>

                    <!-- ETHNICITY -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}ethnicity" class="col-xs-2 col-form-label">Ethnicity</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput codeDis" id="{{prefix}}ethnicity"
                                    name="ethnicity" required>
                                <option></option>
                                <template is="dom-repeat" items="{{config.ethnicity}}">
                                    <option value="{{item.id}}">{{item.title}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_ethnicity"></div>
                        </div>
                    </div>


                    <!-- HPO TERM (ONTOLOGY) -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}HPO" class="col-xs-2 col-form-label">HPO</label>
                        <div class="col-xs-6">
                            <div class="input-group">
                                <textarea class$="form-control {{prefix}}TextInput codeDis" id="{{prefix}}HPO"
                                          name="HPO"
                                          placeholder="HP:0000947" data-error="An HPO term must be selected" readonly rows="2"
                                          style="resize:none"></textarea>
                                <span class="input-group-addon btn btn-primary" on-click="openModalHpo">
                                    <i class="fa fa-search" aria-hidden="true"></i>
                                </span>
                            </div>
                            <span class="fa form-control-feedback" aria-hidden="true"
                                  style="padding-right:60px; padding-top:10px; z-index:5"></span>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>

                    <!-- DIAGNOSIS (ONTOLOGY) -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}diagnosis" class="col-xs-2 col-form-label">Diagnosis</label>
                        <div class="col-xs-6">
                            <div class="input-group">
                                <textarea class$="form-control {{prefix}}TextInput" id="{{prefix}}diagnosis"
                                          name="diagnosis"
                                          placeholder="ICD-10 term"
                                          data-error="A diagnosis term must be selected" readonly rows="2"
                                          style="resize:none"></textarea>
                                <span class="input-group-addon btn btn-primary" id="{{prefix}}icdButton"
                                      on-click="showICD">
                                    <i class="fa fa-search" aria-hidden="true"></i>
                                </span>
                            </div>
                            <span class="fa form-control-feedback" aria-hidden="true"
                                  style="padding-right:60px; padding-top:10px; z-index:5"></span>
                            <div class="help-block with-errors"></div>

                        </div>
                    </div>

                    <!-- PARENTAL CONSANGUINITY -->
                    <div class="form-group row has-feedback">
                        <label class="col-xs-2 col-form-label">Parental Consanguinity</label>
                        <div class="col-xs-6">
                            <div class="form-check form-check-inline">
                                <label class="form-check-label codeDis">
                                    <input id="{{prefix}}parentalConsanguinityno"
                                           class$="form-check-input {{prefix}}RadioInput" type="radio"
                                           name="parentalConsanguinity" value="false" checked> no
                                    <input id="{{prefix}}parentalConsanguinityyes"
                                           class$="form-check-input {{prefix}}RadioInput" type="radio"
                                           name="parentalConsanguinity" value="true"> yes
                                </label>
                            </div>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>


                    <h3 class="clinical-title">Upload and check file</h3>

                    <!-- SAMPLE TYPE -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}sampleType" class="col-xs-2 col-form-label">Type of sample</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}sampleType"
                                    name="sampleType" required>
                                <option></option>
                                <template is="dom-repeat" items="{{config.sample_type}}">
                                    <option value="{{item.id}}">{{item.title}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_sampleType"></div>
                        </div>
                    </div>


                    <!-- CELL LINE -->
                    <div class="form-group row has-feedback">
                        <label class="col-xs-2 col-form-label">Cell line</label>
                        <div class="col-xs-6">
                            <template is="dom-repeat" items="{{config.cell_line}}">
                                <div class="form-check form-check-inline">
                                    <label class="form-check-label">
                                        <input id="{{prefix}}{{item.id}}" class$="form-check-input {{prefix}}RadioInput"
                                               type="radio" name="cellLine" value="{{item.title}}"
                                               checked="{{item.checked}}"> {{item.title}}
                                    </label>
                                </div>
                            </template>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>

                    <!-- SPECIFIC FIELDS FROM VARIABLE SET -->
                    <template id="{{prefix}}VariableTemplate" is="dom-repeat" items="{{variables}}" as="variable"
                              sort="_sortVariables">

                        <template is="dom-if" if="{{isVisible(variable,config)}}">
                            <div class="form-group row has-feedback">

                                <!-- We first try to display 'title', if not present then we use 'name' -->
                                <template is="dom-if" if="{{variable.title}}">
                                    <label for="{{prefix}}{{variable.name}}" class="col-xs-2 col-form-label">{{variable.title}}</label>
                                </template>

                                <template is="dom-if" if="{{!variable.title}}">
                                    <label for="{{prefix}}{{variable.name}}" class="col-xs-2 col-form-label">{{variable.name}}</label>
                                </template>

                                <template is="dom-if" if="{{checkVarType(variable, 'TEXT')}}">
                                    <!-- TEXT type: include an input text and add suitable regular expression for text-->
                                    <!-- http://stackoverflow.com/questions/14237686/disabling-controls-in-bootstrap-->

                                    <template is="dom-if" if="{{checkSubType(variable, 'STRING')}}">
                                        <!-- String subtype: include an input text and add suitable regular expression for text-->
                                        <div class="col-xs-6">
                                            <input type="text" class$="form-control {{prefix}}TextInput"
                                                   id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                                   placeholder="{{variable.defaultValue}}"
                                                   maxlength="{{variable.attributes.maxLength}}" required
                                                   data-error="{{variable.attributes.errorPattern}}"
                                                   pattern="{{variable.attributes.pattern}}">
                                            <span class="fa form-control-feedback" aria-hidden="true"></span>
                                            <div class="help-block with-errors"></div>
                                        </div>
                                    </template>

                                    <template is="dom-if" if="{{checkSubType(variable, 'TEXT')}}">
                                        <!-- String subtype: include a text area and add suitable regular expression for text-->
                                        <div class="col-xs-6">
                                            <template is="dom-if" if="{{variable.required}}">
                                                <textarea class$="form-control {{prefix}}TextInput"
                                                          id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                                          placeholder="{{variable.defaultValue}}"
                                                          maxlength="{{variable.attributes.maxLength}}" required rows="5"
                                                          data-error="{{variable.attributes.errorPattern}}"
                                                          pattern="{{variable.attributes.pattern}}"></textarea>
                                            </template>
                                            <template is="dom-if" if="{{!variable.required}}">
                                                <textarea class$="form-control {{prefix}}TextInput"
                                                          id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                                          placeholder="{{variable.defaultValue}}"
                                                          maxlength="{{variable.attributes.maxLength}}" rows="5"
                                                          data-error="{{variable.attributes.errorPattern}}"
                                                          pattern="{{variable.attributes.pattern}}"></textarea>
                                            </template>
                                            <span class="fa form-control-feedback" aria-hidden="true"></span>
                                            <div class="help-block with-errors"></div>
                                        </div>
                                    </template>

                                    <template is="dom-if" if="{{!checkSubType(variable, 'STRING')}}">
                                        <template is="dom-if" if="{{!checkSubType(variable, 'TEXT')}}">
                                            <!-- String subtype: include an input text and add suitable regular expression for text-->
                                            <div class="col-xs-6">
                                                <input type="text" class$="form-control {{prefix}}TextInput"
                                                       id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                                       placeholder="{{variable.defaultValue}}"
                                                       maxlength="{{variable.attributes.maxLength}}" required
                                                       data-error="{{variable.attributes.errorPattern}}"
                                                       pattern="{{variable.attributes.pattern}}">
                                                <span class="fa form-control-feedback" aria-hidden="true"></span>
                                                <div class="help-block with-errors"></div>
                                            </div>
                                        </template>
                                    </template>
                                </template>

                                <template is="dom-if" if="{{checkVarType(variable, 'INTEGER')}}">
                                    <!-- INTEGER type: include an input text and add suitable regular expression for numbers -->
                                    <div class="col-xs-6">
                                        <template is="dom-if" if="{{variable.attributes.disabled}}">

                                            <input type="text" class$="form-control {{prefix}}TextInput"
                                                   id="{{prefix}}{{variable.name}}" readonly name="{{variable.name}}"
                                                   placeholder="{{variable.title}} number" pattern="^[0-9]+$" maxlength="75"
                                                   required data-error="Mandatory field. Only numbers are allowed ">
                                        </template>
                                        <template is="dom-if" if="{{!variable.attributes.disabled}}">

                                            <input type="text" class$="form-control {{prefix}}TextInput"
                                                   id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                                   placeholder="{{variable.title}} number" pattern="^[0-9]+$" maxlength="75"
                                                   required data-error="Mandatory field. Only numbers are allowed ">
                                        </template>
                                        <span class="fa form-control-feedback" aria-hidden="true"></span>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkVarType(variable, 'DOUBLE')}}">
                                    <!-- DOUBLE type: include an input text and add suitable regular expression for numbers -->
                                    <div class="col-xs-6">
                                        <input type="text" class$="form-control {{prefix}}TextInput"
                                               id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                               placeholder="{{variable.name}} number" pattern="^[0-9]+$" maxlength="75"
                                               required data-error="Mandatory field. Only numbers are allowed ">
                                        <span class="fa form-control-feedback" aria-hidden="true"></span>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 0, 1)}}">
                                    <!-- CATEGORICAL type, no value: values to be filled in this code -->
                                    <!-- Dropdown related to years : fill in with values contained in {{years}} -->
                                    <template is="dom-if" if="{{checkType(variable.name,'Year')}}">
                                        <div class="col-xs-6">
                                            <select class$="form-control {{prefix}}SelectInput"
                                                    id="{{prefix}}{{variable.name}}" name="{{variable.name}}" required
                                                    on-change="checkYears">
                                                <option></option>
                                                <template is="dom-repeat" items="{{yearsTest}}">
                                                    <option value="{{item}}">{{item}}</option>
                                                </template>
                                            </select>
                                            <div class="help-block with-errors"
                                                 id="{{prefix}}_errorDiv_{{variable.name}}"></div>
                                        </div>
                                    </template>

                                </template>

                                <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 1, 2)}}">
                                    <!-- CATEGORICAL type, single value: check box -->
                                    <div class="col-xs-6">
                                        <input class$="{{prefix}}CheckInput" type="checkbox"
                                               id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                               value="{{variable.name}}" style="padding-left: 20px" required>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 2, 3)}}">
                                    <!-- CATEGORICAL type, 2 values: radio buttons for selection -->
                                    <!--<label class="col-sm-3 control-label">{{variable.name}}-{{variable.type}}</label>-->
                                    <div class="col-xs-6">
                                        <template is="dom-repeat" items="{{variable.allowedValues}}" as="value">
                                            <div class="form-check form-check-inline">
                                                <label class="form-check-label">
                                                    <input id="{{prefix}}{{variable.name}}{{value}}"
                                                           class$="form-check-input {{prefix}}RadioInput" type="radio"
                                                           name="{{variable.name}}" value="{{value}}"> {{value}}
                                                </label>
                                            </div>
                                        </template>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 3, 500)}}">
                                    <!-- CATEGORICAL type: dropdown: at least three elements in variable.allowedValues -->
                                    <div class="col-xs-3">
                                        <select class$="form-control {{prefix}}SelectInput"
                                                id="{{prefix}}{{variable.name}}" name="{{variable.name}}" required
                                                on-change="updateSelect">
                                            <option></option>
                                            <template is="dom-repeat" items="{{variable.allowedValues}}">
                                                <option value="{{item}}">{{item}}</option>
                                            </template>
                                        </select>
                                        <div class="help-block with-errors"
                                             id="{{prefix}}_errorDiv_{{variable.name}}"></div>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkVarType(variable, 'BOOLEAN')}}">
                                    <!-- BOOLEAN type, 2 values: radio buttons for selection: yes or no -->
                                    <!--<label class="col-sm-3 control-label">{{variable.name}}-{{variable.type}}</label>-->
                                    <div class="col-xs-6">
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label">
                                                <input id="{{prefix}}{{variable.name}}yes"
                                                       class$="form-check-input {{prefix}}RadioInput" type="radio"
                                                       name="{{variable.name}}" value="true"> yes
                                                <input id="{{prefix}}{{variable.name}}no"
                                                       class$="form-check-input {{prefix}}RadioInput" type="radio"
                                                       name="{{variable.name}}" value="false"> no
                                            </label>
                                        </div>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </template>

                    <div class="form-group row">
                        <label for="uploadInputFileVCF" class="col-xs-2 col-form-label">VCF or gVCF file</label>
                        <div class="col-xs-6">
                            <div class="input-group">
                                <input type="text" class$="form-control {{prefix}}TextInput" id="uploadInputFileVCF"
                                       name="inputFile" readonly required>
                                <span class="input-group-btn">
                                    <label class="btn btn-primary" for="{{prefix}}FileToUpload">
                                        <input id="{{prefix}}FileToUpload" type="file" style="display:none;"
                                               onchange="$('#uploadInputFileVCF')[0].value=$(this).val().replace('C:\\fakepath\\','');">
                                        ...
                                    </label>
                                </span>
                            </div>
                        </div>
                        <span class='label label-info' id="upload-file-info"></span>
                    </div>

                    <!--<div class="form-group row" style="float: right; width: 55%;">-->
                    <div class="form-group row" style="padding-left: 240px;">
                        <button type="button" class="btn btn-primary" on-click="_clearHtmlDom">Clear form</button>
                        <button type="submit" class="btn btn-primary" on-click="submitForm">Upload and check sample
                        </button>
                    </div>
                </form>

            </div>
        </div>

       <variant-modal-ontology prefix="{{prefix}}" ebi-config="{{ebiConfig}}" on-propagateok="propagateOkHPO" ontology-filter="{{ontologyFilter}}"
                             term="{{ontologyTerm}}" selected-terms="{{selectedTermsOntology}}"></variant-modal-ontology>

        <!-- Modal dialog for ICD-10 diagnosis selector-->
        <div class="modal fade" id="{{prefix}}icd" tabindex="-1" role="dialog"
             aria-labelledby="icdLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-sm" role="document" style="width: 1300px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="{{prefix}}Icd10EditorLabel">Diagnosis selector (ICD-10 Terms)</h4>
                    </div>
                    <div class="modal-body" style="height: 500px">
                        <div class="col-sm-12">
                            <label>Introduce an ICD-10 term or select it from tree</label>
                        </div>
                        <div class="col-sm-6" style="overflow-y: auto; height:400px;">
                            <input id="{{prefix}}autoInput" list="icd_browser" class$="form-control {{prefix}}TextInput"
                                   placeholder="ICD-10 term" on-change="selectTermICDDatalist" on-input="selectTermICDDatalist">
                            <datalist id="icd_browser" style="height:auto; max-height:100px; overflow-x:hidden;">
                                <template is="dom-repeat" items="{{icdTerms}}">
                                    <option value="{{item}}">
                                </template>

                            </datalist>
                            <template is="dom-if" if="{{selectedTermICD}}">
                                <ul class="list-group infoHpo">
                                    <li class="list-group-item"><strong>Term: </strong>{{selectedTermICD}}</li>
                                    <li class="list-group-item">  <button type="button" class="btn btn-info" on-click="addSelectedTermToListICD" data-selected-term$="{{selectedTermICD}}">Add Term</button>
                                    </li>
                                </ul>
                            </template>
                            <ul class="list-group">
                                <template is="dom-repeat" items="{{listCurrentSelectedICD}}">
                                    <li class="list-group-item">{{item}}) <button type="button" class="btn danger" on-click="deletedTermFromListICD" data-selected-term$="{{item}}">X</button></li>
                                </template>
                            </ul>
                        </div>
                        <div class="col-sm-6" style="overflow-y: auto; height:400px;">
                            <div id="{{prefix}}ICDtree"></div>
                        </div>
                        <div>
                            <div class="col-sm-3"></div>
                            <div class="col-sm-6" id="{{prefix}}errorTermDiv"><label></label></div>
                            <div class="col-sm-3"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" on-click="selectICD">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal dialog for VCF upload-->
        <div class="modal fade" id="{{prefix}}uploadModal" tabindex="-1" role="dialog"
             aria-labelledby="uploadLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-sm" role="document" style="width: 500px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="{{prefix}}uploadLabel">VCF upload</h4>
                    </div>
                    <div class="modal-body" style="height: 200px">
                        <div class="col-sm-12">
                            <label>VCF has been uploaded. You can now proceed to Analysis</label>
                            VCF validation is under progress.
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <opencga-message-dialog opencga-client="{{opencgaClient}}" show-message-modal="{{showMessageModal}}"
                                settings-message-modal="{{settingsMessageModal}}"></opencga-message-dialog>
    </template>

    <script>
        class VariantClinicalUpload extends Polymer.Element {
            static get is() {
                return 'variant-clinical-upload';
            }

            static get properties() {
                return {
                    opencgaClient: {
                        type: Object
                    },
                    study: {
                        type: Number,
                        observer: 'updateVariableSets'
                    },
                    project: {
                        type: Object
                    },
                    config: {
                        type: Object
                    },
                    prefix: {
                        type: String
                    },
                    variableSets: {
                        type: Array
                    },
                    variables: {
                        type: Array,
                        observer: 'variablesChanged'
                    },
                    minYearBirth: {
                        type: Number,
                        value: 1920
                    },
                    minYearTest: {
                        type: Number,
                        value: 2005
                    },
                    clearDom: {
                        type: Object,
                        observer: "_clearHtmlDom"
                    },
                    showMessageModal: {
                        type: Boolean,
                        notify: true
                    },
                    settingsMessageModal: {
                        type: Object,
                        notify: true
                    }
                }
            }

            constructor() {
                super();
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            ready() {
                super.ready();
                if (UtilsNew.isEmpty(this.prefix)) {
                    this.prefix = "upload" + Utils.randomString(6);
                }

                let _years = [];
                let fullDate = new Date();
                let limitYear = fullDate.getFullYear();
                let year = 0;
                for (year = this.minYearBirth; year <= limitYear; year++) {
                    _years.push(year);
                }
                // This change triggers the polymer dom-repeat
                this.yearsBirth = _years;

                _years = [];
                for (year = this.minYearTest; year <= limitYear; year++) {
                    _years.push(year);
                }
                // This change triggers the polymer dom-repeat
                this.yearsTest = _years;
                this.ontologyFilter = "hp";
                this.matchingKaryotypicSex = new Map();
                this.matchingKaryotypicSex.set("XX", "FEMALE");
                this.matchingKaryotypicSex.set("XY", "MALE");
                this.matchingKaryotypicSex.set("XXX", "FEMALE");
                this.matchingKaryotypicSex.set("XXY", "MALE");
                this.matchingKaryotypicSex.set("XXYY", "MALE");
                this.matchingKaryotypicSex.set("XXXY", "MALE");
                this.matchingKaryotypicSex.set("XXXX", "FEMALE");
                this.matchingKaryotypicSex.set("XYY", "MALE");
                this.matchingKaryotypicSex.set("XO", "FEMALE");
                this.matchingKaryotypicSex.set("UNKNOWN", "UNKNOWN");
                this.matchingKaryotypicSex.set("UNDETERMINED", "UNDETERMINED");
            }

            connectedCallback() {
                this._clearHtmlDom();
                PolymerUtils.getElementById(this.prefix + "autoInput").addEventListener("input", function () {
                    $(PolymerUtils.getElementById(this.prefix + "ICDtree")).treeview('collapseAll', {silent: true});
                    $(PolymerUtils.getElementById(this.prefix + "ICDtree")).treeview('search', [this.value, {
                        ignoreCase: true,     // case insensitive
                        exactMatch: false,    // like or equals
                        revealResults: true,  // reveal matching nodes
                    }]);
                });
                this.loadICDEditor();
            }


            selectTermICDDatalist(e){
                this.selectedTermICD = e.target.value;

            }
            updateVariableSets() {
                this.variables = [];
                let _this = this;
                this.opencgaClient.studies().info(this.study.id, {include: "variableSets"})
                        .then(function (response) {
                            _this.variableSets = response.response[0].result[0].variableSets;
                            if (_this.variableSets.length > 0) {
                                _this.variables = _this.variableSets[0].variables; // setting first one by default
                                _this.filteredVariables = {
                                    variableSet: _this.variableSets[0].id,
                                    variables: []
                                };
                            } else {
                                _this.variableSets = [{name: "none"}];
                            }
                        })
                        .catch(function (response) {
                            console.log("Could not obtain the variable sets of the study " + _this.study);
                            _this.settingsMessageModal = {
                                messageHeader: "Error",
                                messageBody: [response.error],
                                type: "danger",
                                height: "100px",
                                width: "500px"
                            };
                            _this.set('settingsMessageModal', _this.settingsMessageModal);
                            _this.showMessageModal = true;

                        });
                this.loadICDEditor();
            }

            _sortVariables(a, b) {
                return a.rank < b.rank ? -1 : 1;
            }

            variablesChanged() {
                this._areVariablesEmpty = (this.variables.length === 0);
            }

            checkCatType(myVar, type, lowerLimit, upperLimit) {
                return (myVar.type === type && myVar.allowedValues.length >= lowerLimit && myVar.allowedValues.length < upperLimit);
            }

            checkVarType(myVar, type) {
                return (myVar.type === type);
            }

            checkSubType(myVar, type) {
                return (myVar.attributes.subtype === type);
            }

            isVisible(myVar, conf) {
                let excludeArray = conf.variableSet.exclude
                for (let index in excludeArray) {
                    if (excludeArray[index].webComponent == this.localName) {
                        return (!($.inArray(myVar.name, excludeArray[index].variables) != -1));
                    } else {
                        return true;
                    }
                }
            }

            checkType(str1, str2) {
                return str1.search(str2) != -1
            }

            checkYears(e) {
//                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed

                let identifier = e.target.id;
                let message = '';
                let currentElement = $();
                let valueCE = '';
                let pairElement = $();
                let valuePE = '';

                PolymerUtils.innerHTML(this.prefix + '_errorDiv_birthYear', '');
                PolymerUtils.innerHTML(this.prefix + '_errorDiv_testYear', '');

                if (identifier.search('birthYear') != -1) {    // Birth year element raises the event -> check Test year
                    // Check Year of Test
                    PolymerUtils.innerHTML(this.prefix + '_errorDiv_age', '');
                    currentElement = PolymerUtils.getElementById(identifier);
                    valueCE = PolymerUtils.querySelector('option:checked', currentElement).textContent;
                    pairElement = PolymerUtils.getElementById(this.prefix + "testYear");
                    valuePE = PolymerUtils.querySelector('option:checked', pairElement).textContent;

                    if (UtilsNew.isNotEmpty(valuePE) && (parseInt(valueCE) > parseInt(valuePE))) { // Year of birth cannot be lower than Year of test
                        message = "Year of Birth must be prior to year of Test. ";
                        PolymerUtils.innerHTML(this.prefix + '_errorDiv_birthYear', message);
                    }
                    this.calculateYearOfTest();

                }

            }

            loadICDEditor(e) {
                PolymerUtils.innerHTML(this.prefix + "errorTermDiv", "");
                PolymerUtils.setPropertyById(this.prefix + "autoInput", 'value', '');

                this.icdTerms = this.getICDTermsRecursive(ICD_10);

                let _this = this;
                $(PolymerUtils.getElementById(this.prefix + "ICDtree")).treeview({
                    data: ICD_10,
                    onNodeSelected: function (event, node) {
                        _this.selectedTermICD = node.text;
                        PolymerUtils.setValue(_this.prefix + "autoInput", _this.selectedTermICD);
                    },
                    onNodeUnselected: function (event, node) {
                        PolymerUtils.setValue(_this.prefix + "autoInput", '');
                    },
                });

                $(PolymerUtils.getElementById(this.prefix + "ICDtree")).treeview('collapseAll', {silent: true});
            }

            addSelectedTermToListICD(e){
                let selectedTerm = e.target.getAttribute("data-selected-term");
                if (UtilsNew.isUndefinedOrNull(this.listCurrentSelectedICD)) {
                    this.listCurrentSelectedICD = [];
                }

                let containsSelectedElement = this.listCurrentSelectedICD.find((element) => {
                        return element === selectedTerm;
                });

                if (UtilsNew.isUndefinedOrNull(containsSelectedElement)) {
                    selectedTerm.split("(");
                    this.push("listCurrentSelectedICD", selectedTerm);
                }
            }

            deletedTermFromListICD(e){
                let deletedTerm = e.target.getAttribute("data-selected-term");

                let listWithoutDeletedTerm = this.listCurrentSelectedICD.filter((element) => {
                        return element !== deletedTerm;
                });

                this.listCurrentSelectedICD = listWithoutDeletedTerm;
            }

            getICDTermsRecursive(array, res = []){
                array.forEach((element) => {
                    res.push(element.text);
                    if (UtilsNew.isNotUndefinedOrNull(element.nodes)){
                        res = this.getICDTermsRecursive(element.nodes, res.slice())
                    }
                });

                return res;
            }


            selectICD(e) {
                e.preventDefault();

                let selectedTerm = PolymerUtils.getElementById(this.prefix + "autoInput").value.replace(/^\s+/g, '');
                if (selectedTerm !== "") { // Check that the term is correct (one of the list)
                    let _icdTermsNS = this.icdTerms.map(function (elem) {
                        return elem.replace(/^\s+/g, '')
                    });
                    if (_icdTermsNS.indexOf(selectedTerm) != -1) {
                        PolymerUtils.setValue(this.prefix + "diagnosis", this.listCurrentSelectedICD.join(","));
                        $(PolymerUtils.getElementById(this.prefix + "icd")).modal('hide');
                    } else {
                        PolymerUtils.innerHTML(this.prefix + "errorTermDiv", "A proper ICD-10 term must be selected from the list or tree");
                    }
                } else {
                    PolymerUtils.setValue(this.prefix + "diagnosis", "");
                    $(PolymerUtils.getElementById(this.prefix + "icd")).modal('hide');
                }
            }

            openModalHpo(){
                this.selectedTermsOntology = this.selectedTermsHPO;
                this.ontologyFilter = "hp";
                this.ontologyTerm = "HPO";
                $("#" + this.prefix + "ontologyModal").modal('show');
            }

            propagateOkHPO(e){
                PolymerUtils.setValue(this.prefix + "HPO", e.detail.result.join(","));
                this.selectedTermsHPO = e.detail.originalResult;
                $("#" + this.prefix + "ontologyModal").modal('hide');
            }

            updateSelect(e) {
                PolymerUtils.innerHTML(this.prefix + "_errorDiv_testAge", "");
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                let currentElementId = e.target.id;
                // Dropdown related to birthplace

                if (currentElementId === this.prefix + "birthPlace") {
                    if (PolymerUtils.getValue(currentElementId) == 'Spain') {
                        //hide
                        PolymerUtils.hide('otherCountryDiv');
                        PolymerUtils.removeAttribute(this.prefix + 'otherCountry', 'required');
                        PolymerUtils.removeAttribute(this.prefix + 'birthPlaceRegion', 'disabled');
                        PolymerUtils.setAttribute(this.prefix + 'birthPlaceRegion', 'required', true);
                    } else {
                        PolymerUtils.setAttribute(this.prefix + 'birthPlaceRegion', 'disabled', true);
                        PolymerUtils.setAttribute(this.prefix + 'birthPlaceRegion', 'selectedIndex', 0);
                        PolymerUtils.setPropertyById(this.prefix + 'birthPlaceRegion', 'value', 'unknown');
                        PolymerUtils.removeAttribute(this.prefix + 'birthPlaceRegion', 'required');
                        if (PolymerUtils.getValue(currentElementId) == 'Other') {// Display input text to introduce country
                            //show
                            PolymerUtils.show('otherCountryDiv');
                            PolymerUtils.setAttribute(this.prefix + 'otherCountry', 'required', true);
                        } else {
                            PolymerUtils.hide('otherCountryDiv');
                            PolymerUtils.removeAttribute(this.prefix + 'otherCountry', 'required');
                        }
                    }

                    // Year of test element raises the event -> swap elements and check the birth year
                    let currentElement = PolymerUtils.getElementById(this.prefix + 'birthYear');
                    let valueCE = PolymerUtils.querySelector('option:checked', currentElement).textContent;
                    let pairElement = PolymerUtils.getElementById(e.target.id);
                    let valuePE = PolymerUtils.querySelector('option:checked', pairElement).textContent;

                    if (valuePE != '' && (parseInt(valueCE) > parseInt(valuePE))) { // Year of birth cannot be lower than Year of test
                        PolymerUtils.innerHTML(this.prefix + '_errorDiv_testYear', 'Year of Test must be posterior to year of Birth');
                    }
                }
                this.calculateYearOfTest();
            }

            _clearHtmlDom() {
                //TODO Refactor
                $(PolymerUtils.getElementById(this.prefix + "uploadForm")).validator('destroy');
                // Empty everything before rendering
                PolymerUtils.setPropertyByClassName(this.prefix + 'SelectInput', 'selectedIndex', 0);
                PolymerUtils.setPropertyByClassName(this.prefix + 'TextInput', 'value', '');
                PolymerUtils.setPropertyByClassName(this.prefix + 'CheckInput', 'checked', false);
                PolymerUtils.setPropertyByClassName(this.prefix + 'RadioInput', 'checked', false);
                PolymerUtils.setAttributeByClassName(this.prefix + 'birthPlaceRegion', 'disabled', true);
                PolymerUtils.removeAttributebyclass('codeDis', 'disabled', false);

                PolymerUtils.setPropertyById(this.prefix + 'parentalConsanguinityno', 'checked', true);
                PolymerUtils.setPropertyById(this.prefix + 'germline', 'checked', true);
                //TODO Refactor
                $(PolymerUtils.getElementById(this.prefix + "uploadForm")).validator('update');
            }

            indexVCF(fileId) {
                // Index and annotate a VCF file in openCGA
                let params = {
                    file: fileId,
                    study: this.project.alias + ":" + this.study.alias,
                    outDir: fileId + "_index_annot",
                    calculateStats: true,
                    annotate: true
                };
                let _this = this;
                _this.fileId = fileId;
                this.opencgaClient.variants().index(params)
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(function () {
                            console.log("Could not index file " + _this.fileId);
                        });

                this.settingsMessageModal = {
                    messageHeader: "",
                    messageBody: ["The VCF file has successfully uploaded and annotated. You can now proceed to Analysis tab or upload another VCF file"],
                    type: "success",
                    height: "100px",
                    width: "500px"
                };
                this.set('settingsMessageModal', this.settingsMessageModal);
                this.showMessageModal = true;
                this._clearHtmlDom();
            }

            uploadVCF(formFields) {
                // Upload VCF file to openCGA
                if (this.opencgaClient instanceof OpenCGAClient) {
                    let params = {
                        study: this.project.alias + ":" + this.study.alias,
                        type: "FILE",
                        file: PolymerUtils.getPropertyById(this.prefix + "FileToUpload", "files")[0],
                        fileFormat: "VCF",
                        bioformat: "VARIANT",
                        relativeFilePath: "."
                    };

                    let _this = this;

                    this.opencgaClient.files().upload(params)
                            .then(function (response) {
                                // 3. Index and annotate VCF
                                let _fileId = response.response[0].result[0].id;
                                _this.indexVCF(_fileId);
                            })
                            .catch(function (responseError) {
                                _this.settingsMessageModal = {
                                    messageHeader: "Error",
                                    messageBody: [responseError.error],
                                    type: "danger",
                                    height: "100px",
                                    width: "500px"
                                };

                                _this.showMessageModal = true;
                            });
                }
            }

            openCGAsteps(formFields, sampleId) {
                // The following steps are run to register the form in openCGA:
                // 1. Create sample (given an ID) and the individual information related to that sample, together with sample annotation set
                // 2. Upload VCF
                // 3. Index and annotate the VCF file (using fileId obtained in step 2)
                if (this.opencgaClient instanceof OpenCGAClient) {
                    // 1. Create sample
                    let isSomatic = (formFields.cellLine === "somatic");
                    let hasParentalConsanguinity = (formFields.parentalConsanguinity === "true");
                    let icdTermField = formFields.diagnosis;
                    let icdName = "";
                    let icdId = "";
//                    let regexICD = new RegExp("/([?:\s*[a-zA-Z0-9]*]*)\(([^)]+)\)");
//                    let regexHPO = new RegExp("/,?[^,]*,?");
                    let listOntologyTerms = [];
                    if (icdTermField !== "") {
                        this.listCurrentSelectedICD.forEach((icdTerm) => {
                            let groupsIcd = icdTerm.split("(");
                            if (UtilsNew.isNotUndefinedOrNull(groupsIcd) && groupsIcd.length > 0) {
                                listOntologyTerms.push({id: groupsIcd[1].split(")")[0], name: groupsIcd[0], source: "ICD10"});
                            }
                        });
                    }

                    let hpoNames = formFields.HPO;
                    if (hpoNames !== "") {
//                        listOntologyTerms.push({id: Utils.randomString(6), name: hpoNames, source:"HPO"});

                        this.selectedTermsHPO.forEach((hpoTerm) => {
//                            let groupsHpo = regexHPO.exec(hpoTerm);
//                            if(UtilsNew.isNotUndefinedOrNull(groupsHpo) && groupsHpo.length > 0){
                                listOntologyTerms.push({id: hpoTerm.obo_id, name: hpoTerm.label, source:"HPO"});
//                            }
                        });
                    }


                    let jsonAnnotation = {};
                    $(this.variableSets[0].variables).each(function (index, currentVariable) {
                        jsonAnnotation[currentVariable.name] = formFields[currentVariable.name];
                    });

                    let params = {
                        study: this.project.alias + ":" +  this.study.alias
                    };

                    let sexIndividual = this.matchingKaryotypicSex.get(formFields.chromosomalGender);
                    let body = {
                            "name": formFields.patientID,
                            "ethnicity": formFields.ethnicity,
                            "dateOfBirth": formFields.birthYear,
                            "population": {
                                "name": formFields.birthPlace,
                                "subpopulation": formFields.birthPlaceRegion,
                                "description": ""
                            },
                            "karyotypicSex": formFields.chromosomalGender,
                            "sex": UtilsNew.isNotUndefinedOrNull(sexIndividual) ? sexIndividual : "UNKNOWN",
                            "lifeStatus": formFields.lifeStatus,
                            "affectationStatus": formFields.status,
                            "parentalConsanguinity": hasParentalConsanguinity,
                            "phenotypes": listOntologyTerms,
                            "samples":[{
                                "name": sampleId,
                                "type": formFields.sampleType,
                                "somatic": isSomatic,
                                "annotationSets": [
                                    {
                                        "name": "annotation_sample_" + sampleId,
                                        "variableSet": this.variableSets[0].id,
                                        "annotations": jsonAnnotation
                                    }
                                ],
                                "phenotypes": listOntologyTerms
                            }]
                        };

                    let _this = this;
                    this.opencgaClient.individuals().create(params, body)
                            .then(function (response) {
                                _this.uploadVCF(formFields);
                            })
                            .catch(function (response) {
                                _this.settingsMessageModal = {
                                    messageHeader: "Error",
                                    messageBody: [response.error],
                                    type: "danger",
                                    height: "100px",
                                    width: "500px"
                                };

                                _this.showMessageModal = true;
                            });
                }
            }

            submitForm(e) {
                e.preventDefault();

                // Enable those fields that needed to be enabled to submit a form
                PolymerUtils.removeAttributebyclass('codeDis', 'disabled');

                // Get values from form fields
                //TODO Refactor
                let fields = $(PolymerUtils.getElementById(this.prefix + "uploadForm")).serializeArray();

                let formFields = {};

                // fill-in variable set
                //TODO Refactor
                $(fields).each(function (index, field) {
                    formFields[field.name] = field.value;
                });

                // Some checks before submitting VCF to Catalog
                if (window.File && window.FileReader && window.FileList && window.Blob) {
                    let vcfFile = PolymerUtils.getPropertyById(this.prefix + 'FileToUpload', 'files')[0];

                    // Linux text/vcard
                    // Winwdows text/x-card text/x-vcard
                    ///MAC text/directory
                    if ((vcfFile.type === 'text/vcard' || vcfFile.type === "text/x-card" || vcfFile.type === "text/x-vcard" || vcfFile.type === "text/directory") && vcfFile.name.split('.').pop() === 'vcf') {

                        let reader = new FileReader();
                        let _this = this;

                        reader.onload = (function () {
                            // Get SampleID from VCF file
                            let content = reader.result.split('\n');
                            let i = 0;
                            let sampleId = "";
                            while (i < content.length) {
                                if (content[i].startsWith('#CHROM')) {
                                    let headerColumns = content[i].split('\t');
                                    if (headerColumns.length != 10) {
                                        this.settingsMessageModal = {
                                            messageHeader: "Error",
                                            messageBody: ["VCF file does not have proper number of data columns which are CHROM POS ID REF ALT QUAL FILTER INFO FORMAT <sample>. Besides, notice that for this version VCF multisample is not allowed"],
                                            type: "danger",
                                            height: "100px",
                                            width: "500px"
                                        };
                                        this.set('settingsMessageModal', this.settingsMessageModal);
                                        this.showMessageModal = true;
                                    }
                                    else {
                                        sampleId = headerColumns[headerColumns.length - 1];
                                        break;
                                    }
                                }
                                i++;

                            }
                            // Register the form in openCGA through different steps
                            _this.openCGAsteps(formFields, sampleId);

                        });
                        reader.onerror = (function () {
                            _this.settingsMessageModal = {
                                messageHeader: "Error",
                                messageBody: ["The VCF file couldn't be read"],
                                type: "danger",
                                height: "100px",
                                width: "500px"
                            };
                            _this.set('settingsMessageModal', _this.settingsMessageModal);
                            _this.showMessageModal = true;
                        });

                        reader.readAsText(vcfFile);
                    } // Type of file: VCF or not
                    else {
                        this.settingsMessageModal = {
                            messageHeader: "Error",
                            messageBody: ["The file selected is not a VCF file"],
                            type: "danger",
                            height: "100px",
                            width: "500px"
                        };
                        this.set('settingsMessageModal', this.settingsMessageModal);
                        this.showMessageModal = true;

                    }
                } // Whether browser supports FILE API
                else {
                    this.settingsMessageModal = {
                        messageHeader: "Error",
                        messageBody: ["Your browser is not supported. The latest version of Google Chrome is recommended (https://www.google.es/chrome/browser/desktop/index.html)"],
                        type: "danger",
                        height: "100px",
                        width: "500px"
                    };
                    this.set('settingsMessageModal', this.settingsMessageModal);
                    this.showMessageModal = true;
                }
            }

            searchIndividual() {
                if (this.opencgaClient instanceof OpenCGAClient) {
                    // 1. Create individual
                    let params = {
                        study: this.study.alias
                    };

                    let _this = this;
                    let _individualId = PolymerUtils.getElementById(this.prefix + "patientID").value;
                    this.opencgaClient.individuals().info(_individualId, params, {"method": "GET"})
                            .then(function (response) {
                                if (response.response[0].numResults >= 1) {
                                    let formFields = response.response[0].result[0];

                                    PolymerUtils.setAttribute(_this.prefix + 'patientID', 'disabled', true);
                                    PolymerUtils.setPropertyById(_this.prefix + 'chromosomalGender', 'value', formFields.karyotypicSex);
                                    PolymerUtils.setAttribute(_this.prefix + 'chromosomalGender', 'disabled', true);
                                    PolymerUtils.setPropertyById(_this.prefix + 'status', 'value', formFields.affectationStatus);
                                    PolymerUtils.setAttribute(_this.prefix + 'status', 'disabled', true);
                                    PolymerUtils.setPropertyById(_this.prefix + 'lifeStatus', 'value', formFields.lifeStatus);
                                    PolymerUtils.setAttribute(_this.prefix + 'lifeStatus', 'disabled', true);
                                    PolymerUtils.setPropertyById(_this.prefix + 'birthYear', 'value', formFields.dateOfBirth);
                                    PolymerUtils.setAttribute(_this.prefix + 'birthYear', 'disabled', true);
                                    PolymerUtils.setPropertyById(_this.prefix + 'birthPlace', 'value', formFields.population.name);
                                    PolymerUtils.setAttribute(_this.prefix + 'birthPlace', 'disabled', true);
                                    PolymerUtils.setPropertyById(_this.prefix + 'birthPlaceRegion', 'value', formFields.population.subpopulation);
                                    PolymerUtils.setAttribute(_this.prefix + 'birthPlaceRegion', 'disabled', true);
                                    PolymerUtils.setPropertyById(_this.prefix + 'ethnicity', 'value', formFields.ethnicity);
                                    PolymerUtils.setAttribute(_this.prefix + 'ethnicity', 'disabled', true);
                                    PolymerUtils.setPropertyById(_this.prefix + 'HPO', 'value', formFields.ontologyTerms[0].name);
                                    PolymerUtils.setAttribute(_this.prefix + 'HPO', 'disabled', true);
                                    PolymerUtils.setPropertyById(_this.prefix + 'diagnosis', 'value', formFields.ontologyTerms[1].name);
                                    if (formFields.parentalConsanguinity === true) {
                                        PolymerUtils.setPropertyById(_this.prefix + 'parentalConsanguinityyes', 'checked', true);
                                    }
                                    else {
                                        PolymerUtils.setPropertyById(_this.prefix + 'parentalConsanguinityno', 'checked', true);
                                    }
                                    //TODO Refactor
                                    $(PolymerUtils.getElementById(_this.prefix + "uploadForm")).validator('update');
                                    $(PolymerUtils.getElementById(_this.prefix + "uploadForm")).validator('validate');
                                }
                            })
                            .catch(function (response) {
                                _this.settingsMessageModal = {
                                    messageHeader: "Error",
                                    messageBody: ["The user " + _individualId + " does not exist"],
                                    type: "danger",
                                    height: "100px",
                                    width: "500px"
                                };
                                _this.set('settingsMessageModal', _this.settingsMessageModal);
                                _this.showMessageModal = true;
                            });
                }
            }

            showICD() {
                let status = PolymerUtils.getElementById(this.prefix + 'status')
                let statusValue = PolymerUtils.querySelector("option:checked", status).textContent;

                if (statusValue === "Control" || statusValue === "Unaffected") {
                    // For a control or unaffected, disable ICD and make it not mandatory
                    this.settingsMessageModal = {
                        messageHeader: "Attention",
                        messageBody: ["For " + statusValue + " patient a diagnostic cannot be chosen"],
                        type: "info",
                        height: "100px",
                        width: "500px"
                    };
                    this.set('settingsMessageModal', this.settingsMessageModal);
                    this.showMessageModal = true;
                    PolymerUtils.setPropertyById(this.prefix + 'diagnosis', 'value', '');
                    PolymerUtils.innerHTML(this.prefix + 'diagnosis', '');
                    PolymerUtils.setAttribute(this.prefix + 'diagnosis', 'placeholder', 'ICD-10 term');
                    PolymerUtils.setAttribute(this.prefix + 'diagnosis', 'required', false);
                }
                else {
                    //TODO Refactor
                    $(PolymerUtils.getElementById(this.prefix + "icd")).modal('show');
                    PolymerUtils.setAttribute(this.prefix + 'diagnosis', 'required', true);
                }
                PolymerUtils.getElementById(this.prefix + "diagnosis").focus();
                //TODO Refactor
                $(PolymerUtils.getElementById(this.prefix + "uploadForm")).validator('update');
            }

            calculateYearOfTest(){
                let birthYear = PolymerUtils.getValue(this.prefix + "birthYear");
                let testYear = PolymerUtils.getValue(this.prefix + "testYear");
                let yearOfTest = 0;
                if (UtilsNew.isNotUndefinedOrNull(birthYear) && UtilsNew.isNotUndefinedOrNull(testYear)) {
                    let birthYearInt = parseInt(birthYear);
                    let testYearInt = parseInt(testYear);

                    if (birthYearInt > 0 && testYear > 0 && birthYear <= testYearInt) {
                        yearOfTest = testYearInt - birthYear;
                        PolymerUtils.setValue(this.prefix + "testAge", yearOfTest);
                    }
                }
            }
        }
        customElements.define(VariantClinicalUpload.is, VariantClinicalUpload);
    </script>
</dom-module>
